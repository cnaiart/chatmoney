import{_ as Q}from"./index.ae25ad6e.js";import{a as X,b as ee,c as te,d as oe,e as se,w as ne,f as E,E as ae,_ as ie}from"./entry.df16adda.js";import{_ as re}from"./nuxt-link.ee69c354.js";import{_ as ce}from"./index.vue.f6fe58b5.js";import{_ as le,a as ue,b as de}from"./index.e1737bf1.js";import{_ as me}from"./index.vue.403e5f16.js";import{u as V}from"./asyncData.10050198.js";import{u as pe}from"./useCopy.20b5e5cf.js";import{u as _e}from"./recharge.98a08a81.js";import{g as fe,c as he,r as ge,a as ye}from"./robot.5da26683.js";import{u as ve}from"./robot.1f59bc2e.js";import{E as xe}from"./el-scrollbar.f4d658ff.js";import{k as we,ah as q,a as B,s as H,b as be,E as ke,n as Ce,j as Ee,I as h,J as S,a2 as l,a0 as r,K as d,u as e,a4 as D,ae as M,Y as L,$ as N,Z as Se,ap as Le}from"./swiper-vue.397ea2eb.js";import"./_plugin-vue_export-helper.c27b6911.js";import"./el-image-viewer.ad15677e.js";import"./throttle.92cc074e.js";import"./debounce.2369182b.js";import"./position.a44f3ead.js";import"./el-link.00e3f970.js";import"./useAudioPlay.49014f22.js";import"./el-dialog.64289190.js";import"./use-dialog.825901d5.js";import"./refs.2a024717.js";import"./unique-id.302803f8.js";import"./chat.e58126ff.js";import"./el-popper.89e34564.js";import"./el-tooltip.4ed993c7.js";const Re={class:"flex h-full"},Ie={key:0,class:"flex items-center"},Te={class:"line-clamp-1"},Ae={class:"h-full flex flex-col"},$e={key:0,class:"bg-white flex items-center p-main m-main rounded-lg"},Ve=["src"],qe={class:"ml-[15px]"},Be={class:"flex items-center"},De={class:"text-2xl line-clamp-1"},Me={class:"text-tx-secondary mt-[4px] line-clamp-2"},Ne={class:"flex-1 min-h-0"},Ue={class:"p-main"},ze={class:"my-[5px]"},ht=we({__name:"chat",async setup(Fe){let p,x;const J=X(),{id:w=""}=J.query,g=ee(),_=te(),t=ve();_e();const{copy:O}=pe();t.setRobotId(w),[p,x]=q(()=>V(()=>t.getSessionLists(),"$wB76LAqO9B")),await p,x(),t.setSessionSelect();const f=B([]),j=oe(),R=async()=>{if(!t.sessionId)return[];const i=await ye({category_id:t.sessionId,robot_id:w,page_size:25e3});f.value=i.lists||[]};[p,x]=q(()=>V(()=>R(),"$TbsLM0WNwm")),await p,x();const{data:a}=([p,x]=q(()=>V(()=>fe({id:w}),"$Uwi0s5LJ5c")),p=await p,x(),p),K=async()=>{if(!_.isLogin)return _.toggleShowLogin();t.sessionId&&(await E.confirm("确定清空记录？"),await he({category_id:t.sessionId,robot_id:w}),R())},I=H(),P=()=>{var i;if(!_.isLogin)return(i=I.value)==null||i.blur(),_.toggleShowLogin();k()};let o=null;const y=B(!1);let A=!1;const U=async(i,m="input")=>{var C;if(!_.isLogin)return _.toggleShowLogin();if(!i)return E.msgError("请输入问题");if(y.value||!w)return;const v=Date.now();y.value=!0,f.value.push({type:1,content:i}),f.value.push({type:2,typing:!0,content:"",key:v}),(C=I.value)==null||C.setInputValue();const s=f.value.find(c=>c.key===v);t.sessionId||(A=!0,await t.sessionAdd(),A=!1),t.getCurrentSession.name==="新的会话"&&await t.sessionEdit({id:t.sessionId,name:i}),o=ge({cate_id:t.sessionId,robot_id:w,question:i}),o.addEventListener("chat",({data:c})=>{const{data:u,index:b}=c;s.content||(s.content=""),s.content+=u}),o.addEventListener("file",({data:c})=>{try{s.files||(s.files=[]),s.files.push({url:c.data})}catch(u){console.error(u)}}),o.addEventListener("image",({data:c})=>{try{s.images||(s.images=[]),s.images.push({url:c.data})}catch(u){console.error(u)}}),o.addEventListener("close",async()=>{await _.getUser(),setTimeout(async()=>{await R(),s.typing=!1,y.value=!1,k()},500)}),o.addEventListener("error",async c=>{var u,b;if(((u=c.data)==null?void 0:u.code)===1100){g.getIsShowRecharge?(await E.confirm(`${g.getTokenUnit}数量已用完，请前往充值`),j.push("/recharge")):E.msgError(`${g.getTokenUnit}数量已用完。请联系客服增加`);return}c.errorType==="connectError"&&E.msgError("请求失败，请重试"),["connectError","responseError"].includes(c.errorType)&&(f.value.splice(f.value.length-2,2),m==="input"&&((b=I.value)==null||b.setInputValue(i))),s.typing=!1,setTimeout(()=>{y.value=!1},200)})},$=H(),z=B(),k=async()=>{var m,v,s;const i=(v=(m=$.value)==null?void 0:m.wrapRef)==null?void 0:v.scrollHeight;(s=$.value)==null||s.setScrollTop(i)},{height:W}=se(z);ne(W,()=>{y.value&&k()},{throttle:500,immediate:!0});const F=()=>{o==null||o.removeEventListener("close"),o==null||o.removeEventListener("chat"),o==null||o.removeEventListener("error"),o==null||o.abort(),y.value=!1};return be(()=>t.sessionId,async i=>{i&&!A&&(F(),await R(),k())},{immediate:!0}),ke(async()=>{await Ce(),f.value.length&&k()}),Ee(()=>{F()}),(i,m)=>{const v=Q,s=ae,C=re,c=ce,u=le,b=de,Y=me,Z=ue,G=ie;return h(),S("div",null,[l(G,{name:"default"},{panel:r(()=>[d("div",Re,[l(v,{modelValue:e(t).sessionId,"onUpdate:modelValue":m[0]||(m[0]=n=>e(t).sessionId=n),data:e(t).sessionLists,onAdd:e(t).sessionAdd,onEdit:e(t).sessionEdit,onDelete:e(t).sessionDelete,onClear:e(t).sessionClear,onClickItem:e(t).setSessionSelect},null,8,["modelValue","data","onAdd","onEdit","onDelete","onClear","onClickItem"])])]),header:r(()=>[e(g).isMobile&&e(a).name?(h(),S("div",Ie,[d("div",Te,D(e(a).name),1),l(C,{to:"/application/layout/robot",class:"ml-[10px]"},{default:r(()=>[l(s,{size:"small",type:"info",round:"",text:"",bg:"",style:{border:"none","--el-button-hover-text-color":"var(--el-color-info)"}},{default:r(()=>[M(" 切换应用 ")]),_:1})]),_:1})])):L("",!0)]),default:r(()=>[d("div",Ae,[e(g).isMobile?L("",!0):(h(),S("div",$e,[d("img",{class:"flex-none w-[40px] h-[40px] rounded-full",src:e(a).image,alt:""},null,8,Ve),d("div",qe,[d("div",Be,[d("div",De,D(e(a).name),1),l(C,{to:"/application/layout/robot",class:"ml-[10px]"},{default:r(()=>[l(s,{type:"info",round:"",text:"",bg:"",style:{border:"none","--el-button-hover-text-color":"var(--el-color-info)"}},{default:r(()=>[M(" 切换应用 ")]),_:1})]),_:1})]),d("div",Me,D(e(a).intro),1)])])),d("div",Ne,[l(e(xe),{ref_key:"scrollbarRef",ref:$},{default:r(()=>[d("div",Ue,[d("div",{ref_key:"innerRef",ref:z,class:"sm:px-[20px]"},[e(a).welcome_introducer?(h(),N(u,{key:0,class:"mb-[20px]",type:"left",avatar:e(a).icons?e(a).icons:e(a).image},{default:r(()=>[l(c,{content:e(a).welcome_introducer,onClickCustomLink:m[1]||(m[1]=n=>U(n,"link"))},null,8,["content"])]),_:1},8,["avatar"])):L("",!0),(h(!0),S(Se,null,Le(e(f),(n,T)=>(h(),S("div",{key:n.id+""+T,class:"mt-4 sm:pb-[20px]"},[n.type==1?(h(),N(u,{key:0,type:"right",avatar:e(_).userInfo.avatar,color:"white"},{actions:r(()=>[d("div",ze,[l(s,{link:"",type:"info",onClick:He=>e(O)(n.content)},{icon:r(()=>[l(Y,{name:"el-icon-CopyDocument"})]),default:r(()=>[M(" 复制 ")]),_:2},1032,["onClick"])])]),default:r(()=>[l(b,{content:String(n.content)},null,8,["content"])]),_:2},1032,["avatar"])):L("",!0),n.type==2?(h(),N(u,{key:1,type:"left",time:n.create_time,avatar:e(a).icons?e(a).icons:e(a).image},{default:r(()=>[l(b,{content:String(n.content),type:"html",typing:n.typing,"line-numbers":!e(g).isMobile,"show-copy":"","show-context":!!e(a).is_show_context,"show-quote":!!e(a).is_show_quote,"show-voice":e(g).getIsVoiceOpen,context:n.context,quotes:n.quotes,images:n.images,files:n.files,"record-id":n.id,"record-type":2},null,8,["content","typing","line-numbers","show-context","show-quote","show-voice","context","quotes","images","files","record-id"])]),_:2},1032,["time","avatar"])):L("",!0)]))),128))],512)])]),_:1},512)]),l(Z,{ref_key:"chatActionRef",ref:I,loading:e(y),"show-manual":!!e(a).is_artificial,onEnter:U,onClear:K,onPause:m[2]||(m[2]=n=>{var T;return(T=e(o))==null?void 0:T.abort()}),onFocus:P,menus:e(a).menus},null,8,["loading","show-manual","menus"])])]),_:1})])}}});export{ht as default};
