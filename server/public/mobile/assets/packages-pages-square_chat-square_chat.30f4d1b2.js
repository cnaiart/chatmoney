import{d as e,s as a,M as t,o as l,k as o,b as s,w as n,f as i,t as r,e as u,K as c,F as d,l as p,r as v,a as m,j as f,I as _,c as h,m as y,u as g,A as x,L as w,G as b,x as k,H as j,aE as C,g as V,aO as T,n as q,aG as P,aH as R,aP as z,z as A,ad as U,aD as D,p as F,R as I,aF as L,h as N,T as S}from"./index-9f08b835.js";import{_ as $}from"./page-meta.d2ccf398.js";import{_ as B}from"./u-icon.f0423eb2.js";import{_ as H}from"./router-navigate.3e9d7fb5.js";import{_ as O}from"./chat-record-item.e0ff5f51.js";import{_ as J}from"./u-tag.d6be710f.js";import{_ as E,a as K,b as M}from"./dialog-poster.vue_vue_type_script_setup_true_lang.53970165.js";import{_ as G}from"./z-paging.5d396652.js";import{_ as Y}from"./l-textarea.5288c032.js";import{_ as Q}from"./u-button.cd082997.js";import{_ as W}from"./u-popup.6c89de8e.js";import{l as X,f as Z,m as ee,h as ae,j as te,i as le,r as oe,v as se}from"./robot.8b2fb6bb.js";import{u as ne}from"./useLockFn.cde70c0d.js";import{_ as ie}from"./u-image.e6fb9592.js";import{_ as re}from"./_plugin-vue_export-helper.1b428a4d.js";import{_ as ue,a as ce}from"./context-popup.vue_vue_type_script_setup_true_lang.5d43fac0.js";import{u as de}from"./text-item.75b27895.js";import{u as pe,a as ve}from"./useRecorder.3e996450.js";import{u as me}from"./useAudio.8d04ba62.js";import"./u-loading.15b95fef.js";import"./icon_copy.bacd4068.js";import"./useCopy.7659937f.js";import"./uni-file-picker.55c7ce72.js";import"./u-input.6dc4a2b4.js";import"./emitter.1571a5d9.js";import"./index.f8572cdb.js";import"./index.73309c03.js";import"./l-painter-image.bb294855.js";import"./l-painter.d7281161.js";import"./ua-markdown.f5ba7fba.js";import"./katex.30814119.js";import"./_commonjsHelpers.157f59fb.js";import"./mp-html.6ddc2dff.js";import"./index.c3709e84.js";import"./icon_copy.36709540.js";import"./chat.05123b79.js";import"./howler.bdae6f69.js";const fe=re(e({__name:"square-robot",props:{data:{required:!0,type:Array},modelValue:{required:!0,type:[String,Number]}},emits:["update:modelValue"],setup(e,{emit:g}){const x=e,w=a(!1),b=t((()=>{var e;return(null==(e=x.data)?void 0:e.find((e=>e.id===Number(k.value))))||{}})),k=t({get:()=>x.modelValue,set:e=>{g("update:modelValue",e)}});return(a,t)=>{const g=v(m("u-icon"),B),x=f,j=v(m("u-image"),ie),C=_,V=v(m("u-popup"),W);return l(),o(d,null,[s(x,{class:"bg-white flex items-center px-[20rpx] py-[24rpx]"},{default:n((()=>[s(g,{name:"list",size:40,onClick:t[0]||(t[0]=e=>w.value=!0)}),s(x,{class:"flex-1 line-clamp-1 ml-[20rpx]"},{default:n((()=>[i(r(u(b).name),1)])),_:1}),c(a.$slots,"right",{},void 0,!0)])),_:3}),s(V,{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=e=>w.value=e),mode:"left",width:"480rpx","safe-area-inset-bottom":""},{default:n((()=>[s(x,{class:"h-full"},{default:n((()=>[s(C,{"scroll-y":"",class:"h-full"},{default:n((()=>[s(x,{class:"p-[20rpx]"},{default:n((()=>[(l(!0),o(d,null,p(e.data,(e=>(l(),h(x,{class:y(["robot-item",{"robot-item--active":e.id===Number(u(k))}]),key:e.id,onClick:a=>{return t=e.id,k.value=t,void(w.value=!1);var t}},{default:n((()=>[s(j,{src:e.image,shape:"circle",width:"80",height:"80"},null,8,["src"]),s(x,{class:"flex-1 min-w-0 ml-[20rpx]"},{default:n((()=>[s(x,{class:"line-clamp-1 font-medium text-xl"},{default:n((()=>[i(r(e.name),1)])),_:2},1024),s(x,{class:y(["text-muted line-clamp-1",{"!text-white":e.id===Number(u(k))}])},{default:n((()=>[i(r(e.intro),1)])),_:2},1032,["class"])])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-2c3be87d"]]),_e=re(e({__name:"square_chat",setup(e){const{pauseAll:c}=de(),ie=g(),re=A(),_e=U(),he=x(),ye=w(),ge=a(!1),xe=a([]),we=a(1),be=t((()=>2===we.value)),ke=a(0);b({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."});const je=w(),Ce=e=>{2===we.value&&(ke.value=e)},Ve=a(!1),Te=a(0),qe=a(!1),Pe=a(0),Re=a(0),ze=a(!0),Ae=b({id:"audio-canvas",width:100,height:30,minHeight:5,scale:2}),{render:Ue,stopRender:De,draw:Fe}=pe(Ae),{start:Ie,stop:Le,isRecording:Ne,authorize:Se,close:$e}=ve({onstart(){qe.value=!1,Te.value=Date.now()},async onstop(e){if(De(),setTimeout((()=>{Fe(new Float64Array(new Array(128).fill(0)),0)}),10),Ve.value){Ve.value=!1,Ce(3);try{const a=await te(e.tempFilePath);if(!a.text)return void(ze.value&&Ce(2));ya(a.text,"voice")}catch(a){ze.value&&Ce(1)}}},ondata(e){Ue(e);const a=Date.now();e.powerLevel>15&&(clearTimeout(Pe.value),ke.value=2,qe.value=!0,Te.value=a,Pe.value=setTimeout((()=>{Ve.value=!0,clearTimeout(Re.value),Le()}),2e3)),a-Te.value>=5e3&&qe.value}}),{play:Be,pause:He,isPlaying:Oe}=me({onstart(){ke.value=4,Ke.value&&(Ke.value=!1,Le())},onstop(){var e;Re.value=setTimeout((()=>{Me()}),1e3*(null==(e=Qe.value.digital)?void 0:e.idle_time)||0),ze.value?Ce(2):Ce(1)},onerror(){Ce(1)}}),Je=async e=>{const{url:a}=await se(e);return a},Ee=a(""),Ke=a(!1),Me=async()=>{if(2!==we.value)return Promise.reject();if(!Qe.value.is_digital||!Qe.value.digital_id||Qe.value.is_disable)return Promise.reject();if(Ee.value||(Ee.value=await Je({type:3,record_id:Qe.value.id})),!Ee.value)return Promise.reject();Ke.value=!0;const e=Date.now();xe.value.push({type:2,typing:!1,content:Qe.value.digital.idle_reply,key:e}),await S(),da(),Be(Ee.value)};k(we,(async e=>{if(1===e)He(),$e(),ke.value=0,clearTimeout(Re.value);else{ze.value=!0,await Se(),Fe(null,0);try{await Me()}catch(a){Ce(2)}da()}})),k(ke,(e=>{if(2===e)(async()=>{Ne.value||2!==we.value||Ie()})()}));const Ge=b({show:!1,data:[]}),Ye=b({show:!1,data:[]});a(!1);const Qe=a({}),We=a(""),Xe=a(""),Ze=()=>{if(!he.isLogin)return ba();da()},ea=a(_e.query.id),aa=a([]),ta=t((()=>aa.value.find((e=>e.id===Number(ea.value)))||{})),la=t((()=>ta.value.robot_id)),oa=w();let sa=0;const na=async(e,a)=>{var t,l;try{const{lists:l=[],count:o}=await Z({square_id:ta.value.id,robot_id:la.value,page_size:a/2,page_no:e});if(null==(t=oa.value)||t.complete(l.reverse()),0===o?setTimeout((()=>{var e;null==(e=oa.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{da()}),100),2===we.value&&3==ke.value){const e=l[0];e&&e.id!==sa&&(sa=e.id,(async e=>{try{const a=await Je({type:2,record_id:e});Be(a)}catch(a){Ce(1)}})(sa))}}catch(o){null==(l=oa.value)||l.complete(!1)}},ia=a(!1),ra=e=>{e.height>0?ia.value=!0:ia.value=!1},ua=()=>{ia.value=!1},{lockFn:ca}=ne((async()=>{var e;if(!he.isLogin)return ba();(await I({title:"温馨提示",content:"确定清空对话？"})).cancel||(fa(),await le({robot_id:la.value,square_id:ta.value.id}),null==(e=oa.value)||e.reload())})),da=async()=>{var e;null==(e=oa.value)||e.scrollToBottom(!1)},pa=a(!1);let va=null;const ma=a([]),fa=()=>{null==va||va.cancel(),setTimeout((()=>{We.value=""}))},_a=a({}),{pauseAll:ha}=de(),{lockFn:ya}=ne((async(e,a="text")=>{if(ge.value=!1,!he.isLogin)return ba();if(pa.value)return;const t=e||We.value;if(t){oa.value.addChatRecordData({type:1,content:t}),_a.value={type:2,loading:!0,content:[],id:Date.now()},oa.value.addChatRecordData(_a.value),Xe.value=We.value,We.value="";try{pa.value=!0,Ce(3),await oe({cate_id:0,square_id:ta.value.id,robot_id:la.value,question:t,stream:!0},{onstart(e){va=e,ha(),We.value=""},onmessage(e){e.trim().split("data:").forEach((async e=>{var a,t,l,o;if(""!==e)try{const n=JSON.parse(e),{object:i,choices:r,error:u}=n;if(u){const{message:e,code:a}=u;return e&&uni.$u.toast(e),void xe.value.splice(0,2)}const c=null==(t=null==(a=r[0])?void 0:a.delta)?void 0:t.content;switch(i){case"chat":_a.value.content||(_a.value.content=""),_a.value.content+=c;break;case"question":ma.value=JSON.parse(null==(o=null==(l=r[0])?void 0:l.delta)?void 0:o.content);break;case"image":case"video":case"file":{const e=`${i}s`;try{const a=JSON.parse(c);_a.value[e]=a}catch(s){console.error(s)}}}}catch(n){}}))},onclose(){pa.value=!1,setTimeout((()=>{var e;null==(e=oa.value)||e.reload(),he.getUser()}),600)}})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==L.ABORT&&xe.value.splice(0,2),"text"==a&&(We.value=Xe.value),pa.value=!1}}})),ga=a(!1),xa=b({_index:-1,robot_id:-1,record_id:-1,content:""}),wa=async()=>{try{await ee(xa),ga.value=!1,xa.content="",xe.value[xa._index].is_feedback=1}catch(e){console.log("反馈提交失败--\x3e",e)}},ba=()=>{re.navigateTo({path:"/pages/login/login"})},ka=async()=>{Qe.value=await ae({id:la.value})};return k(ea,(e=>{we.value=1,ka(),setTimeout((()=>{var a,t;e?null==(a=oa.value)||a.reload():(null==(t=oa.value)||t.complete([]),setTimeout((()=>{var e;null==(e=oa.value)||e.scrollToTop(!1)}),100))}),10)})),j((async()=>{var e;await(async()=>{aa.value=await X()})(),ka(),null==(e=oa.value)||e.reload()})),C((()=>{fa()})),(e,a)=>{const t=v(m("page-meta"),$),g=f,x=v(m("u-icon"),B),w=v(m("router-navigate"),H),b=D,k=v(m("chat-record-item"),O),j=v(m("u-tag"),J),C=N,A=_,U=v(m("chat-input"),K),I=v(m("z-paging"),G),L=v(m("l-watermark"),M),S=v(m("l-textarea"),Y),X=v(m("u-button"),Q),Z=v(m("u-popup"),W);return l(),o(d,null,[s(t,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),s(g,{class:"h-full flex flex-col"},{default:n((()=>[s(g,null,{default:n((()=>[V(' <u-navbar\n                :title="robotInfo.name"\n                title-color="#333"\n                :title-bold="true"\n            ></u-navbar> '),s(fe,{data:aa.value,modelValue:ea.value,"onUpdate:modelValue":a[0]||(a[0]=e=>ea.value=e)},T({_:2},[Qe.value.is_digital?{name:"right",fn:n((()=>[s(w,{to:{path:"/packages/pages/digital_chat/digital_chat",query:{id:u(la),squareId:u(ta).id}},onClick:u(c)},{default:n((()=>[s(g,{class:"flex items-center"},{default:n((()=>[s(g,{class:"mr-[10rpx]"},{default:n((()=>[i(" 形象对话 ")])),_:1}),s(x,{name:"arrow-rightward"})])),_:1})])),_:1},8,["to","onClick"])])),key:"0"}:void 0]),1032,["data","modelValue"])])),_:1}),s(g,{class:"flex-1 min-h-0 relative",style:q({background:u(be)?Qe.value.digital_bg:""})},{default:n((()=>[u(be)?(l(),h(g,{key:0,class:"absolute inset-0"},{default:n((()=>{var e,a;return[P(s(b,{class:"h-full w-full",src:null==(e=Qe.value.digital)?void 0:e.vertical_stay_video,autoplay:"",muted:"",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"contain"},null,8,["src"]),[[R,!u(Oe)]]),P(s(b,{class:"h-full w-full",src:null==(a=Qe.value.digital)?void 0:a.vertical_talk_video,autoplay:"",muted:"",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"contain"},null,8,["src"]),[[R,u(Oe)]])]})),_:1})):V("v-if",!0),s(g,{class:"h-full flex flex-col"},{default:n((()=>[s(g,{class:"flex-1 min-h-0"},{default:n((()=>[s(L,{class:"flex-1 min-h-0",content:u(ie).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:n((()=>[s(I,{ref_key:"pagingRef",ref:oa,modelValue:xe.value,"onUpdate:modelValue":a[2]||(a[2]=e=>xe.value=e),"use-chat-record-mode":"",auto:!1,"safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,onQuery:na,fixed:!1,onKeyboardHeightChange:ra,onHidedKeyboard:ua},{empty:n((()=>[s(g,{class:"w-full min-h-full pt-[40rpx]"},{default:n((()=>[Qe.value.welcome_introducer?(l(),h(k,{key:0,class:y({"opacity-50":u(be)}),type:"left",content:Qe.value.welcome_introducer,avatar:Qe.value.icons?Qe.value.icons:Qe.value.image,showCopyBtn:!1,onClickLink:u(ya)},null,8,["class","content","avatar","onClickLink"])):V("v-if",!0)])),_:1})])),bottom:n((()=>[s(g,{class:y({" bg-white":!u(be)})},{default:n((()=>[s(U,{class:y({"!bg-[transparent]":!0}),modelValue:We.value,"onUpdate:modelValue":a[1]||(a[1]=e=>We.value=e),loading:pa.value||3===ke.value,"show-stop":pa.value,"safe-area-inset-bottom":!Qe.value.copyright,onSend:u(ya),onPause:fa,onFocus:Ze,onClear:u(ca)},{actions:n((()=>[s(A,{class:"w-full whitespace-nowrap","scroll-x":""},{default:n((()=>[(l(!0),o(d,null,p(Qe.value.menus,((e,a)=>(l(),h(g,{class:"menus bg-page px-[30rpx] rounded-full mr-[20rpx] py-[10rpx] inline-block",key:a,onClick:a=>u(ya)(e.keyword)},{default:n((()=>[i(r(e.keyword),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1},8,["modelValue","loading","show-stop","safe-area-inset-bottom","onSend","onClear"]),V(' <view\n                                        v-if="robotInfo.copyright"\n                                        class="pb-[20rpx] text-center text-content safe-area-inset-bottom"\n                                    >\n                                        {{ robotInfo.copyright }}\n                                    </view> ')])),_:1},8,["class"])])),default:n((()=>[s(g,{class:"scroll-view-content pb-[40rpx]",ref_key:"contentRef",ref:ye},{default:n((()=>[(l(!0),o(d,null,p(xe.value,((e,a)=>(l(),h(g,{key:`${e.id} + ${a} + ''`,style:{transform:"scaleY(-1)"}},{default:n((()=>[s(g,{class:"chat-record mt-[20rpx] pb-[40rpx]"},{default:n((()=>[1==e.type?(l(),h(k,{key:0,type:"right",content:e.content,avatar:u(he).userInfo.avatar,showCopyBtn:!0,class:y({"opacity-50":u(be)})},null,8,["content","avatar","class"])):V("v-if",!0),2==e.type?(l(),h(k,{key:1,class:y({"opacity-50":u(be)}),"record-id":e.id,type:"left",content:e.content,loading:e.loading,avatar:Qe.value.icons?Qe.value.icons:Qe.value.image,index:a,chatType:2,time:e.create_time,showCopyBtn:!0,images:e.images,files:e.files,videos:e.videos,showVoiceBtn:!0,"model-name":e.model,"show-poster":"",onPoster:a=>(async e=>{const a=xe.value.filter((a=>a.id==e));2==a.length?je.value.initPosterData({title:a[1].content,content:a[0].content}):uni.$u.toast("上下文数据不对～")})(e.id)},{btn:n((()=>[s(g,{class:"flex items-center"},{default:n((()=>{var a,t;return[Qe.value.is_show_quote&&(null==(a=e.quotes)?void 0:a.length)?(l(),h(g,{key:0,class:"text-content text-sm flex items-center mr-[20rpx] mt-[16rpx]",onClick:a=>{return t=e.quotes,Ye.show=!0,void(Ye.data=t);var t}},{default:n((()=>{var a;return[i(r(null==(a=e.quotes)?void 0:a.length)+"条引用 ",1)]})),_:2},1032,["onClick"])):V("v-if",!0),Qe.value.is_show_context&&(null==(t=e.context)?void 0:t.length)?(l(),h(g,{key:1,class:"text-content text-sm flex items-center mr-[20rpx] mt-[16rpx]",onClick:a=>{return t=e.context,Ge.show=!0,void(Ge.data=t);var t}},{default:n((()=>{var a;return[i(r(null==(a=e.context)?void 0:a.length)+"条上下文 ",1)]})),_:2},1032,["onClick"])):V("v-if",!0)]})),_:2},1024)])),sub_actions:n((()=>[e.create_time?(l(),h(g,{key:0,class:"ml-[86rpx] mt-2"},{default:n((()=>[s(j,{text:e.is_feedback?"已反馈":"反馈",type:e.is_feedback?"info":"primary",size:"mini",style:{"--color-primary-light-3":"transparent","--color-info-light-3":"transparent"},onClick:t=>((e,a)=>{1!==xe.value[a].is_feedback&&(xa.robot_id=la.value,xa.record_id=e.id,xa._index=a,ga.value=!0)})(e,a)},null,8,["text","type","onClick"])])),_:2},1024)):V("v-if",!0),0!==a||pa.value?V("v-if",!0):(l(),h(g,{key:1,class:"flex flex-col",style:{"margin-left":"84rpx"}},{default:n((()=>[(l(!0),o(d,null,p(ma.value.length?ma.value:e.correlation,((e,a)=>(l(),h(g,{key:a,class:"inline-flex items-center rounded-md bg-white cursor-pointer mt-[20rpx]",style:{padding:"16rpx 24rpx",width:"fit-content"},onClick:F((a=>u(ya)(e)),["stop"])},{default:n((()=>[s(C,{class:"mr-1 text-base text-content"},{default:n((()=>[i(r(e),1)])),_:2},1024),s(x,{name:"arrow-rightward",color:"#999",size:"30"})])),_:2},1032,["onClick"])))),128))])),_:2},1024))])),_:2},1032,["class","record-id","content","loading","avatar","index","time","images","files","videos","model-name","onPoster"])):V("v-if",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["modelValue"])])),_:1},8,["content","font"])])),_:1})])),_:1})])),_:1},8,["style"]),V("  会话弹窗  "),V(' <session-popup\n            v-model:show="showPopup"\n            v-model="sessionActive"\n            :lists="sessionLists"\n            @add="sessionAdd"\n            @clear="sessionClear"\n            @delete="sessionDelete"\n            @edit="sessionEdit"\n        /> '),s(ue,z(Ye,{show:Ye.show,"onUpdate:show":a[3]||(a[3]=e=>Ye.show=e)}),null,16,["show"]),s(ce,z(Ge,{show:Ge.show,"onUpdate:show":a[4]||(a[4]=e=>Ge.show=e)}),null,16,["show"]),V(" 内容反馈 "),s(Z,{modelValue:ga.value,"onUpdate:modelValue":a[6]||(a[6]=e=>ga.value=e),"safe-area-inset-bottom":"",closeable:"","border-radius":"16",mode:"center"},{default:n((()=>[s(g,{class:"flex flex-col",style:{width:"600rpx"}},{default:n((()=>[s(g,{class:"text-xl mx-[20rpx] py-[28rpx] font-bold border-b border-solid border-light border-0"},{default:n((()=>[i(" 问题反馈 ")])),_:1}),s(g,{class:"flex-1 min-h-0 px-[20rpx] pb-[30rpx]"},{default:n((()=>[s(g,{class:"py-[20rpx]"},{default:n((()=>[s(S,{modelValue:xa.content,"onUpdate:modelValue":a[5]||(a[5]=e=>xa.content=e),placeholder:"描述一下你遇到了什么问题"},null,8,["modelValue"])])),_:1}),s(X,{type:"primary",onClick:wa},{default:n((()=>[i("提交反馈")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),V("  生产对话海报  "),s(E,{ref_key:"posterRef",ref:je},null,512)])),_:1})],64)}}}),[["__scopeId","data-v-760f747e"]]);export{_e as default};
