import{d as e,u as a,A as t,L as l,s,M as o,G as i,Z as r,aK as n,aE as u,o as c,k as d,b as p,c as v,w as m,g as f,e as g,aG as y,aH as h,f as x,t as w,F as _,l as A,p as k,B as b,m as j,n as R,z as C,ad as T,R as z,r as F,a as B,i as D,j as I,aD as E,I as U,aw as P,aF as Q,T as V}from"./index-9f08b835.js";import{_ as H}from"./page-meta.d2ccf398.js";import{_ as J}from"./chat-record-item.e0ff5f51.js";import{_ as L}from"./z-paging.5d396652.js";import{_ as q}from"./u-icon.f0423eb2.js";import{_ as M}from"./u-button.cd082997.js";import{_ as S}from"./u-input.6dc4a2b4.js";import{_ as $}from"./dragon-button.22a5d4d2.js";import{_ as G}from"./u-empty.765dbffc.js";import{_ as O,a as N,b as K}from"./icon_clear.1440a0f3.js";import{f as W,v as X,h as Y,i as Z,r as ee,j as ae}from"./robot.8b2fb6bb.js";import{u as te}from"./useLockFn.cde70c0d.js";import{u as le}from"./text-item.75b27895.js";import{u as se,a as oe}from"./useRecorder.3e996450.js";import{u as ie}from"./useAudio.8d04ba62.js";import{_ as re}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-image.e6fb9592.js";import"./u-tag.d6be710f.js";import"./u-loading.15b95fef.js";import"./icon_copy.bacd4068.js";import"./useCopy.7659937f.js";import"./emitter.1571a5d9.js";import"./ua-markdown.f5ba7fba.js";import"./katex.30814119.js";import"./_commonjsHelpers.157f59fb.js";import"./mp-html.6ddc2dff.js";import"./index.c3709e84.js";import"./icon_copy.36709540.js";import"./chat.05123b79.js";import"./howler.bdae6f69.js";import"./index.f8572cdb.js";import"./index.73309c03.js";const ne=re(e({__name:"digital_chat",setup(e){a();const re=C(),ne=T(),ue=t(),ce=l(),de=s(!1),pe=s([]),ve=o((()=>ne.query.id)),me=o((()=>ne.query.squareId)),fe=o((()=>ne.query.cateId)),ge=s({}),ye=s(""),{isLock:he,lockFn:xe}=te((async()=>{ge.value=await Y({id:ve.value})})),we=()=>{re.navigateBack()},_e=s(0),Ae=i({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."}),ke=l();let be=0;const je=async(e,a)=>{var t,l;try{const{lists:l=[],count:s}=await W({category_id:fe.value,square_id:me.value,robot_id:ve.value,page_size:a/2,page_no:e});if(null==(t=ke.value)||t.complete(l.reverse()),0===s?setTimeout((()=>{var e;null==(e=ke.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{Te()}),100),3==_e.value){const e=l[0];e&&e.id!==be&&(be=e.id,sa(be))}}catch(s){null==(l=ke.value)||l.complete(!1)}},{lockFn:Re}=te((async()=>{var e;if(!ue.isLogin)return Ce();(await z({title:"温馨提示",content:"确定清空对话？"})).cancel||(Be(),await Z({category_id:fe.value,square_id:me.value,robot_id:ve.value}),null==(e=ke.value)||e.reload())})),Ce=()=>{re.navigateTo({path:"/pages/login/login"})},Te=async()=>{var e;null==(e=ke.value)||e.scrollToBottom(!1)},ze=s(!1);let Fe=null;const Be=()=>{null==Fe||Fe.cancel(),setTimeout((()=>{ye.value=""}))},De=l(),Ie=e=>{_e.value=e},Ee=s({}),Ue=s(""),{pauseAll:Pe}=le(),{lockFn:Qe}=te((async(e,a="text")=>{if(de.value=!1,!ue.isLogin)return Ce();if(ze.value)return;const t=e||ye.value;if(t){ke.value.addChatRecordData({type:1,content:t}),Ee.value={type:2,loading:!0,content:[],id:Date.now()},ke.value.addChatRecordData(Ee.value),Ue.value=ye.value,ye.value="";try{ze.value=!0,Ie(3),await ee({square_id:me.value,cate_id:fe.value,robot_id:ve.value,question:t,stream:!0},{onstart(e){Fe=e,Pe(),ye.value=""},onmessage(e){e.trim().split("data:").forEach((async e=>{var a,t;if(""!==e)try{const s=JSON.parse(e),{object:o,choices:i,error:r}=s;if(r){Ie(1);const{message:e,code:a}=r;return e&&uni.$u.toast(e),void pe.value.splice(0,2)}const n=null==(t=null==(a=i[0])?void 0:a.delta)?void 0:t.content;switch(o){case"chat":Ee.value.content||(Ee.value.content=""),Ee.value.content+=n;break;case"image":case"video":case"file":{const e=`${o}s`;try{const a=JSON.parse(n);Ee.value[e]=a}catch(l){console.error(l)}}}}catch(s){}}))},onclose(){ze.value=!1,setTimeout((()=>{var e;null==(e=ke.value)||e.reload(),ue.getUser()}),600)}})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==Q.ABORT&&pe.value.splice(0,2),"text"==a&&(ye.value=Ue.value),ze.value=!1}}})),Ve=()=>{if(!ue.isLogin)return Ce();Te()},He=s(),Je=s(!0),Le=s(!1),qe=s(0),Me=s(!1),Se=s(0),$e=i({id:"audio-canvas",width:60,height:30,minHeight:4,scale:2}),{render:Ge,stopRender:Oe,draw:Ne}=se($e),{start:Ke,stop:We,isRecording:Xe,authorize:Ye,close:Ze,isOpen:ea}=oe({onstart(){Ie(2),ta(),clearTimeout(He.value),Me.value=!1,qe.value=Date.now()},async onstop(e){if(Oe(),Me.value=!1,console.log(Le.value,"isAutoStop"),Le.value){Le.value=!1,Ie(3);try{const a=await ae(e.tempFilePath);if(!a.text)return void(Je.value?oa():Ie(1));Qe(a.text,"voice")}catch(a){Ie(1)}}else Ie(1)},ondata(e){var a;const t=Date.now();Me.value&&Ge(e),e.powerLevel>=10&&(clearTimeout(Se.value),_e.value=2,Me.value=!0,qe.value=t,Se.value=setTimeout((()=>{Le.value=!0,clearTimeout(He.value),ta(),We()}),1500)),t-qe.value>=1e3*(null==(a=ge.value.digital)?void 0:a.idle_time)&&(Me.value||(ca(),We()))}}),{play:aa,pause:ta,isPlaying:la}=ie({onstart(){_e.value=4,ua.value&&(ua.value=!1)},onstop(){Ie(2),Je.value?oa():Ie(1)},onerror(){Ie(1)}}),sa=async e=>{const a=await ra({type:2,record_id:e});aa(a)},oa=async()=>{Xe.value||(await Ye(),Ke())},ia=async()=>{4!=_e.value?3!=_e.value&&(Xe.value?(Je.value=!1,We(),Ie(1)):(Je.value=!0,oa())):ta()},ra=async e=>{try{const{url:a}=await X(e);return a}catch(a){return Ie(1),Promise.reject()}},na=s(""),ua=s(!1),ca=async()=>{if(!ge.value.is_digital||!ge.value.digital_id)return Promise.reject();if(na.value||(na.value=await ra({type:3,record_id:ge.value.id})),!na.value)return Promise.reject();ua.value=!0;const e=Date.now();ke.value.addChatRecordData({type:2,typing:!1,content:ge.value.digital.idle_reply,key:e}),await V(),Te(),aa(na.value)};let da=null,pa=null;const va=async()=>{const{confirm:e}=await z({title:"温馨提示",showCancel:!1,content:"形象内容由AI生成，请合法使用形象"});e&&(null==da||da.play(),null==pa||pa.play()),await Ye(),oa()};return r((async()=>{var e;await xe(),null==(e=ke.value)||e.reload(),Je.value=!0,da=n("stay-video"),pa=n("talk-video")})),u((()=>{Be(),ta(),We()})),(e,a)=>{const t=F(B("page-meta"),H),l=D,s=I,o=E,i=F(B("chat-record-item"),J),r=F(B("z-paging"),L),n=F(B("u-icon"),q),u=F(B("u-button"),M),C=U,T=F(B("u-input"),S),z=P,Q=F(B("dragon-button"),$),V=F(B("u-empty"),G);return c(),d(_,null,[p(t,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),0==_e.value?(c(),v(s,{key:0,class:"h-full flex justify-center items-center fixed inset-0 w-full z-[9999] bg-white"},{default:m((()=>[p(l,{src:O,class:"w-[600rpx]",mode:"widthFix"})])),_:1})):f("v-if",!0),p(s,{class:"h-full container-wrap"},{default:m((()=>[ge.value.digital_id||g(he)?(c(),v(s,{key:0,class:"h-full relative py-[40rpx] px-[20rpx]",style:R({background:ge.value.digital_bg})},{default:m((()=>{var t,F;return[y(p(o,{ref_key:"videoRef",ref:De,id:"stay-video",playsinline:"",muted:"","webkit-playsinline":"","x-webkit-airplay":"allow","x5-video-player-fullscreen":"true","x5-video-player-type":"h5",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"cover",src:null==(t=ge.value.digital)?void 0:t.vertical_stay_video,onLoadedmetadata:va},null,8,["src"]),[[h,4!==_e.value]]),y(p(o,{ref_key:"videoRef",ref:De,id:"talk-video",playsinline:"",muted:"","webkit-playsinline":"","x-webkit-airplay":"allow","x5-video-player-fullscreen":"true","x5-video-player-type":"h5",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"cover",src:null==(F=ge.value.digital)?void 0:F.vertical_talk_video},null,8,["src"]),[[h,4===_e.value]]),p(s,{class:"h-full relative z-10 flex flex-col top-0"},{default:m((()=>[p(s,{class:"flex text-white items-center"},{default:m((()=>[p(s,{class:"flex-1 min-w-0 line-clamp-1 text-xl font-medium"},{default:m((()=>[x(w(ge.value.name),1)])),_:1}),p(s,{class:"bg-[rgba(51,51,51,0.5)] px-[20rpx] py-[10rpx] rounded-full flex items-center",onClick:we},{default:m((()=>[p(l,{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAD7SURBVFiF7ZZRDcIwFEXvIwiYhEpAwiQgAQs4QAIOwMFwMBxMwpCAg8PHOiALWwKjr3xwv5qm6T3Jdu+rgAA0+KsGggG1pFLSSdJVPgrR86hIc3AyvgtogWbhbTxQkRtAf4DsAMvUBsBa0tnMhhHf9geSxRBYxfsboBg7lLQHgN0khEcRTUJ4NeEohGcVP0FUWQAGEAdpRgzjBeUMlg0wq4hex+o9lTk/QQuEXD9hZx43vWP4MPcCGDX3AJg0Tw1A9+IeN1ficWxmF2Ar6WRmlwHcul+4xvAJoAXa7C+iP8DPAHxjsHwkAxpJK0lHR9+gbpTv+7Ko8VcFFDfbwDxYwdth8AAAAABJRU5ErkJggg==",class:"w-[32rpx] h-[32rpx]"}),p(s,{class:"ml-[15rpx]"},{default:m((()=>[x("退出")])),_:1})])),_:1})])),_:1}),p(s,{class:"flex-1 min-h-0 flex flex-col justify-end"},{default:m((()=>[p(r,{ref_key:"pagingRef",ref:ke,modelValue:pe.value,"onUpdate:modelValue":a[0]||(a[0]=e=>pe.value=e),"use-chat-record-mode":"",auto:!1,height:"500rpx",width:"600rpx","safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"auto-adjust-position-when-chat":!1,"default-page-size":20,onQuery:je,fixed:!1},{empty:m((()=>[])),default:m((()=>[p(s,{class:"scroll-view-content pb-[40rpx]",ref_key:"contentRef",ref:ce},{default:m((()=>[(c(!0),d(_,null,A(pe.value,((a,t)=>(c(),v(s,{key:`${a.id} + ${t} + ''`,style:{transform:"scaleY(-1)"}},{default:m((()=>[p(s,{class:"chat-record mt-[20rpx]"},{default:m((()=>[1==a.type?(c(),v(i,{key:0,type:"left",content:a.content,avatar:g(ue).userInfo.avatar,showCopyBtn:!1,bg:e.$theme.primaryColor,color:"#fff"},null,8,["content","avatar","bg"])):f("v-if",!0),2==a.type?(c(),v(i,{key:1,"record-id":a.id,type:"left",bg:"rgba(0, 0, 0, 0.5)",color:"#fff",content:a.content,loading:a.loading,avatar:ge.value.icons?ge.value.icons:ge.value.image,index:t,chatType:2,showCopyBtn:!1,images:a.images,files:a.files,videos:a.videos},null,8,["record-id","content","loading","avatar","index","images","files","videos"])):f("v-if",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["modelValue"]),ze.value?(c(),d("div",{key:0,class:"flex justify-center items-center"},[p(u,{color:"#fff",shape:"circle",size:"medium",onClick:Be},{default:m((()=>[p(n,{class:"mr-[10rpx]",name:"pause-circle",size:30}),x(" 停止 ")])),_:1})])):f("v-if",!0),p(s,{class:"flex flex-col justify-center items-center text-white mt-[20rpx] text-xs"},{default:m((()=>[p(s,null,{default:m((()=>[x(w(Ae[_e.value]),1)])),_:1})])),_:1}),p(s,{class:"my-[20rpx]"},{default:m((()=>[p(C,{class:"w-full whitespace-nowrap","scroll-x":""},{default:m((()=>[(c(!0),d(_,null,A(ge.value.menus,((e,a)=>(c(),v(s,{class:"menus bg-white px-[30rpx] rounded-full mr-[20rpx] py-[12rpx] inline-block",key:a,onClick:a=>g(Qe)(e.keyword)},{default:m((()=>[x(w(e.keyword),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}),p(s,{class:"send-area__content safe-area-inset-bottom"},{default:m((()=>[p(s,{class:"flex-1 min-w-0 relative"},{default:m((()=>[p(T,{modelValue:ye.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ye.value=e),placeholder:"请输入内容",maxlength:"-1","auto-height":!0,"confirm-type":"send","adjust-position":!0,fixed:!1,"adjust-keyboard-to":"bottom",onFocus:Ve},null,8,["modelValue"])])),_:1}),p(s,{class:"ml-[20rpx] mr-[-6rpx]"},{default:m((()=>[p(s,null,{default:m((()=>[p(u,{type:"primary","custom-style":{width:"100rpx",height:"66rpx",margin:"0",borderRadius:"100px",background:"linear-gradient(90deg, #54C6EE 0%, #3C5EFD 100%)!important"},size:"mini",disabled:[3,4].includes(_e.value),onClick:a[2]||(a[2]=k((e=>g(Qe)(ye.value)),["stop"]))},{default:m((()=>[p(l,{src:N,class:"w-[50rpx] h-[50rpx]"})])),_:1},8,["custom-style","disabled"])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),b("div",{class:"gradient-button z-10",onClick:a[3]||(a[3]=(...e)=>g(Re)&&g(Re)(...e))},[p(l,{src:K,class:"w-[40rpx] h-[40rpx]"})]),p(Q,{size:120,xEdge:"10",yEdge:"100"},{default:m((()=>[p(s,{class:j(["recorder-btn",{"recorder-btn--stop":!g(Xe)&&!g(la)}]),onClick:ia},{default:m((()=>[Me.value?(c(),v(z,{key:0,style:R({width:`${$e.width}px`,height:`${$e.height}px`}),width:$e.width*$e.scale,height:$e.height*$e.scale,"canvas-id":$e.id},null,8,["style","width","height","canvas-id"])):f("v-if",!0),g(Xe)&&!Me.value?(c(),v(n,{key:1,name:"mic",size:48})):g(la)?(c(),v(n,{key:2,name:"pause-circle",size:60})):g(Xe)?f("v-if",!0):(c(),v(n,{key:3,name:"mic-off",size:48}))])),_:1},8,["class"])])),_:1})]})),_:1},8,["style"])):(c(),v(s,{key:1,class:"h-screen w-screen flex flex-col items-center justify-center"},{default:m((()=>[p(V,{text:"该智能体暂未配置形象",mode:"page"})])),_:1}))])),_:1})],64)}}}),[["__scopeId","data-v-23889732"]]);export{ne as default};
