import{d as e,L as a,G as t,x as l,aL as s,o,c as i,w as r,b as n,e as u,N as c,r as d,a as p,j as m,A as v,s as f,M as y,Z as h,aE as w,k as g,g as x,aG as _,aH as b,f as k,t as j,F as C,l as z,p as R,B as T,m as F,n as V,ad as D,ab as I,aM as $,aK as O,R as B,i as E,aD as L,I as P,aw as U,aF as q,T as A,h as M}from"./index-9f08b835.js";import{_ as J}from"./page-meta.d2ccf398.js";import{_ as N}from"./chat-record-item.e0ff5f51.js";import{_ as S}from"./u-icon.f0423eb2.js";import{_ as H}from"./z-paging.5d396652.js";import{_ as G}from"./u-button.cd082997.js";import{_ as Q}from"./u-input.6dc4a2b4.js";import{_ as K}from"./dragon-button.22a5d4d2.js";import{_ as X}from"./u-empty.765dbffc.js";import{_ as Y,a as Z,b as W}from"./icon_clear.1440a0f3.js";import{f as ee,v as ae,k as te,i as le,r as se,j as oe}from"./robot.8b2fb6bb.js";import{u as ie}from"./useLockFn.cde70c0d.js";import{u as re}from"./text-item.75b27895.js";import{u as ne,a as ue}from"./useRecorder.3e996450.js";import{u as ce}from"./useAudio.8d04ba62.js";import{_ as de}from"./u-form-item.95df05ac.js";import{_ as pe}from"./u-form.1bf0b756.js";import{_ as me}from"./u-modal.05432cbf.js";import{u as ve}from"./index.f8572cdb.js";import{D as fe}from"./default_avatar.84088887.js";import{_ as ye}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-image.e6fb9592.js";import"./u-tag.d6be710f.js";import"./u-loading.15b95fef.js";import"./icon_copy.bacd4068.js";import"./useCopy.7659937f.js";import"./emitter.1571a5d9.js";import"./ua-markdown.f5ba7fba.js";import"./katex.30814119.js";import"./_commonjsHelpers.157f59fb.js";import"./mp-html.6ddc2dff.js";import"./index.c3709e84.js";import"./icon_copy.36709540.js";import"./chat.05123b79.js";import"./howler.bdae6f69.js";import"./u-popup.6c89de8e.js";import"./index.73309c03.js";const he=e({__name:"login",props:{show:{type:Boolean}},emits:["update:show","confirm"],setup(e,{emit:v}){const f=e,y=a(),h=a(),w=ve(f,"show",v),g=t({password:""});l(w,(e=>{e&&setTimeout((()=>{y.value.setRules(x)}))}));const x=s({password:[{required:!0,message:"请输入密码"}]}),_=async()=>{var e;null==(e=h.value)||e.clearLoading(),y.value.validate((e=>{e&&(v("confirm",g),w.value=!1)}))};return(e,a)=>{const t=d(p("u-input"),Q),l=d(p("u-form-item"),de),s=d(p("u-form"),pe),v=m,f=d(p("u-modal"),me);return o(),i(v,null,{default:r((()=>[n(f,{ref_key:"uModalRef",ref:h,modelValue:u(w),"onUpdate:modelValue":a[1]||(a[1]=e=>c(w)?w.value=e:null),"async-close":!0,onConfirm:_,title:"输入密码"},{default:r((()=>[n(v,{class:"p-[40rpx]"},{default:r((()=>[n(s,{model:g,ref_key:"uFormRef",ref:y,"border-bottom":!1},{default:r((()=>[n(l,{label:"密码",prop:"password",required:""},{default:r((()=>[n(t,{modelValue:g.password,"onUpdate:modelValue":a[0]||(a[0]=e=>g.password=e),placeholder:"请输入密码",border:!0},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1})])),_:1},8,["modelValue"])])),_:1})}}}),we=ye(e({__name:"share_chat",setup(e){const l=D(),s=v(),c=a(),de=f(!1),pe=f([]),me=f(!1),ve=f(""),{key:ye=""}=l.query,we=f({robot:{},digital:{}}),ge=f(""),{isLock:xe,lockFn:_e}=ie((async()=>{we.value=await te({apikey:ye})})),be=y((()=>{var e;return(null==(e=we.value.menus)?void 0:e.map((e=>({keyword:e}))))||[]})),ke=async()=>{const e=I.get($)||{};if(ve.value=e[ye]||"",we.value.pwd&&!ve.value)return me.value=!0,Promise.reject()},je=async e=>{let a=I.get($)||{};ve.value=e.password,a=Object.assign(a,{[ye]:e.password}),I.set($,a),xa()},Ce=f(0),ze=t({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."}),Re=a();let Te=0;const Fe=async(e,a)=>{var t,l;try{const{lists:l=[],count:o}=await ee({share_apikey:ye,identity:s.visitorId,page_size:a/2,page_no:e},{password:ve.value,authorization:ye,identity:s.visitorId});if(null==(t=Re.value)||t.complete(l.reverse()),0===o?setTimeout((()=>{var e;null==(e=Re.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{De()}),100),3==Ce.value){const e=l[0];e&&e.id!==Te&&(Te=e.id,na(Te))}}catch(o){"访问密码错误!"===o&&((()=>{let e=I.get($)||{};e=Object.assign(e,{[ye]:""}),I.set($,e)})(),ke()),null==(l=Re.value)||l.complete(!1)}},{lockFn:Ve}=ie((async()=>{var e;await ke();(await B({title:"温馨提示",content:"确定清空对话？"})).cancel||(Be(),await le({},{password:ve.value,authorization:ye,identity:s.visitorId}),null==(e=Re.value)||e.reload())})),De=async()=>{var e;null==(e=Re.value)||e.scrollToBottom(!1)},Ie=f(!1);let $e=null;const Oe=f([]),Be=()=>{null==$e||$e.cancel(),setTimeout((()=>{ge.value=""}))},Ee=a(),Le=e=>{Ce.value=e},Pe=f({}),Ue=f(""),{pauseAll:qe}=re(),{lockFn:Ae}=ie((async(e,a="text")=>{if(de.value=!1,await s.getFingerprint(),await ke(),Ie.value)return;const t=e||ge.value;if(t){Re.value.addChatRecordData({type:1,content:t}),Pe.value={type:2,loading:!0,content:[],id:Date.now()},Re.value.addChatRecordData(Pe.value),Ue.value=ge.value,ge.value="";try{Ie.value=!0,Le(3),await se({question:t,stream:!0},{onstart(e){$e=e,qe(),ge.value=""},onmessage(e){e.trim().split("data:").forEach((async e=>{var a,t,l,s;if(""!==e)try{const i=JSON.parse(e),{object:r,choices:n,error:u}=i;if(u){Le(1);const{message:e,code:a}=u;return e&&uni.$u.toast(e),void pe.value.splice(0,2)}const c=null==(t=null==(a=n[0])?void 0:a.delta)?void 0:t.content;switch(r){case"chat":Pe.value.content||(Pe.value.content=""),Pe.value.content+=c;break;case"question":Oe.value=JSON.parse(null==(s=null==(l=n[0])?void 0:l.delta)?void 0:s.content);break;case"image":case"video":case"file":{const e=`${r}s`;try{const a=JSON.parse(c);Pe.value[e]=a}catch(o){console.error(o)}}}}catch(i){}}))},onclose(){Ie.value=!1,setTimeout((()=>{var e;null==(e=Re.value)||e.reload()}),600)}},{password:ve.value,authorization:ye,identity:s.visitorId})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==q.ABORT&&pe.value.splice(0,2),"text"==a&&(ge.value=Ue.value),Ie.value=!1}}})),Me=async()=>{await ke(),De()},Je=f(),Ne=f(!0),Se=f(!1),He=f(0),Ge=f(!1),Qe=f(0),Ke=t({id:"audio-canvas",width:60,height:30,minHeight:4,scale:2}),{render:Xe,stopRender:Ye,draw:Ze}=ne(Ke),{start:We,stop:ea,isRecording:aa,authorize:ta,close:la,isOpen:sa}=ue({onstart(){Le(2),clearTimeout(Je.value),ia(),Ge.value=!1,He.value=Date.now()},async onstop(e){if(Ye(),Ge.value=!1,Se.value){Se.value=!1,Le(3);try{const a=await oe(e.tempFilePath);if(!a.text)return void(Ne.value?ua():Le(1));Ae(a.text,"voice")}catch(a){Le(1)}}else Le(1)},ondata(e){var a;const t=Date.now();Ge.value&&Xe(e),e.powerLevel>=10&&(clearTimeout(Qe.value),Ce.value=2,Ge.value=!0,He.value=t,Qe.value=setTimeout((()=>{Se.value=!0,clearTimeout(Je.value),ia(),ea()}),2e3)),t-He.value>=1e3*(null==(a=we.value.digital)?void 0:a.idle_time)&&(Ge.value||(va(),ea()))}}),{play:oa,pause:ia,isPlaying:ra}=ce({onstart(){Ce.value=4,ma.value&&(ma.value=!1)},onstop(){Le(2),Ne.value?ua():Le(1)},onerror(){Le(1)}}),na=async e=>{const a=await da({type:2,record_id:e});oa(a)},ua=async()=>{aa.value||(await ta(),We())},ca=async()=>{4!=Ce.value?3!=Ce.value&&(aa.value?(Ne.value=!1,ea(),Le(1)):(Ne.value=!0,ua())):ia()},da=async e=>{try{const{url:a}=await ae(e,{password:ve.value,authorization:ye,identity:s.visitorId});return a}catch(a){return Le(1),Promise.reject()}},pa=f(""),ma=f(!1),va=async()=>{if(!we.value.is_digital||!we.value.digital_id)return Promise.reject();if(pa.value||(pa.value=await da({type:3,record_id:we.value.id})),!pa.value)return Promise.reject();ma.value=!0;const e=Date.now();Re.value.addChatRecordData({type:2,typing:!1,content:we.value.digital.idle_reply,key:e}),await A(),De(),oa(pa.value)};let fa=null,ya=null,ha=!1,wa=!1;const ga=async()=>{wa=!0,ha&&(await ta(),ua())},xa=async()=>{var e;await ke(),null==(e=Re.value)||e.reload(),Ne.value=!0,fa=O("stay-video"),ya=O("talk-video");const{confirm:a}=await B({title:"温馨提示",showCancel:!1,content:"形象内容由AI生成，请合法使用形象"});a&&(null==fa||fa.play(),null==ya||ya.play(),ha=!0),wa&&(await ta(),ua())};return h((async()=>{await _e(),await s.getFingerprint(),xa()})),w((()=>{Be(),ia(),ea()})),(e,a)=>{const t=d(p("page-meta"),J),l=E,s=m,v=L,f=d(p("chat-record-item"),N),y=M,h=d(p("u-icon"),S),w=d(p("z-paging"),H),D=d(p("u-button"),G),I=P,$=d(p("u-input"),Q),O=U,B=d(p("dragon-button"),K),q=d(p("u-empty"),X);return o(),g(C,null,[n(t,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),0==Ce.value?(o(),i(s,{key:0,class:"h-full flex justify-center items-center fixed inset-0 w-full z-[9999] bg-white"},{default:r((()=>[n(l,{src:Y,class:"w-[600rpx]",mode:"widthFix"})])),_:1})):x("v-if",!0),n(s,{class:"h-full container-wrap"},{default:r((()=>[we.value.digital.id||u(xe)?(o(),i(s,{key:0,class:"h-full relative py-[40rpx] px-[20rpx]",style:V({background:we.value.robot.digital_bg})},{default:r((()=>{var t,d;return[_(n(v,{ref_key:"videoRef",ref:Ee,id:"stay-video",playsinline:"",muted:"","webkit-playsinline":"","x-webkit-airplay":"allow","x5-video-player-fullscreen":"true","x5-video-player-type":"h5",loop:"",autoplay:"false",preload:"none",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"cover",src:null==(t=we.value.digital)?void 0:t.vertical_stay_video,onLoadedmetadata:ga},null,8,["src"]),[[b,4!==Ce.value]]),_(n(v,{ref_key:"videoRef",ref:Ee,id:"talk-video",playsinline:"",muted:"","webkit-playsinline":"","x-webkit-airplay":"allow","x5-video-player-fullscreen":"true","x5-video-player-type":"h5",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"cover",src:null==(d=we.value.digital)?void 0:d.vertical_talk_video},null,8,["src"]),[[b,4===Ce.value]]),n(s,{class:"h-full relative z-10 flex flex-col top-0"},{default:r((()=>[n(s,{class:"flex text-white items-center"},{default:r((()=>[n(s,{class:"flex-1 min-w-0 line-clamp-1 text-xl font-medium"},{default:r((()=>[k(j(we.value.name),1)])),_:1})])),_:1}),n(s,{class:"flex-1 min-h-0 flex flex-col justify-end"},{default:r((()=>[n(w,{ref_key:"pagingRef",ref:Re,modelValue:pe.value,"onUpdate:modelValue":a[0]||(a[0]=e=>pe.value=e),"use-chat-record-mode":"",auto:!1,height:"500rpx",width:"600rpx","safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,onQuery:Fe,fixed:!1},{empty:r((()=>[])),default:r((()=>[n(s,{class:"scroll-view-content pb-[40rpx]",ref_key:"contentRef",ref:c},{default:r((()=>[(o(!0),g(C,null,z(pe.value,((a,t)=>(o(),i(s,{key:`${a.id} + ${t} + ''`,style:{transform:"scaleY(-1)"}},{default:r((()=>[n(s,{class:"chat-record mt-[20rpx]"},{default:r((()=>[1==a.type?(o(),i(f,{key:0,type:"left",content:a.content,avatar:u(fe),showCopyBtn:!1,bg:e.$theme.primaryColor,color:"#fff"},null,8,["content","avatar","bg"])):x("v-if",!0),2==a.type?(o(),i(f,{key:1,"record-id":a.id,type:"left",bg:"rgba(0, 0, 0, 0.5)",color:"#fff",content:a.content,loading:a.loading,avatar:we.value.robot.icons?we.value.robot.icons:we.value.robot.image,index:t,chatType:2,showCopyBtn:!1,images:a.images,files:a.files,videos:a.videos},{sub_actions:r((()=>[0!==t||Ie.value?x("v-if",!0):(o(),i(s,{key:0,class:"flex flex-col",style:{"margin-left":"84rpx"}},{default:r((()=>[(o(!0),g(C,null,z(Oe.value.length?Oe.value:a.correlation,((e,a)=>(o(),i(s,{key:a,class:"inline-flex items-center rounded-md bg-white cursor-pointer mt-[20rpx]",style:{padding:"16rpx 24rpx",width:"fit-content"},onClick:R((a=>u(Ae)(e)),["stop"])},{default:r((()=>[n(y,{class:"mr-1 text-base text-content"},{default:r((()=>[k(j(e),1)])),_:2},1024),n(h,{name:"arrow-rightward",color:"#999",size:"30"})])),_:2},1032,["onClick"])))),128))])),_:2},1024))])),_:2},1032,["record-id","content","loading","avatar","index","images","files","videos"])):x("v-if",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["modelValue"]),Ie.value?(o(),g("div",{key:0,class:"flex justify-center items-center"},[n(D,{color:"#fff",shape:"circle",size:"medium",onClick:Be},{default:r((()=>[n(h,{class:"mr-[10rpx]",name:"pause-circle",size:30}),k(" 停止 ")])),_:1})])):x("v-if",!0),n(s,{class:"flex flex-col justify-center items-center text-white mt-[20rpx] text-xs"},{default:r((()=>[n(s,null,{default:r((()=>[k(j(ze[Ce.value]),1)])),_:1})])),_:1}),n(s,{class:"my-[20rpx]"},{default:r((()=>[n(I,{class:"w-full whitespace-nowrap","scroll-x":""},{default:r((()=>[(o(!0),g(C,null,z(u(be),((e,a)=>(o(),i(s,{class:"menus bg-white px-[30rpx] rounded-full mr-[20rpx] py-[12rpx] inline-block",key:a,onClick:a=>u(Ae)(e.keyword)},{default:r((()=>[k(j(e.keyword),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}),n(s,{class:"send-area__content safe-area-inset-bottom"},{default:r((()=>[n(s,{class:"flex-1 min-w-0 relative"},{default:r((()=>[n($,{modelValue:ge.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ge.value=e),placeholder:"请输入内容",maxlength:"-1","auto-height":!0,"confirm-type":"send","adjust-position":!0,fixed:!1,"adjust-keyboard-to":"bottom",onFocus:Me},null,8,["modelValue"])])),_:1}),n(s,{class:"ml-[20rpx] mr-[-6rpx]"},{default:r((()=>[n(s,null,{default:r((()=>[n(D,{type:"primary","custom-style":{width:"100rpx",height:"66rpx",margin:"0",borderRadius:"100px",background:"linear-gradient(90deg, #54C6EE 0%, #3C5EFD 100%)!important"},size:"mini",disabled:[3,4].includes(Ce.value),onClick:a[2]||(a[2]=R((e=>u(Ae)(ge.value)),["stop"]))},{default:r((()=>[n(l,{src:Z,class:"w-[50rpx] h-[50rpx]"})])),_:1},8,["custom-style","disabled"])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),T("div",{class:"gradient-button z-10",onClick:a[3]||(a[3]=(...e)=>u(Ve)&&u(Ve)(...e))},[n(l,{src:W,class:"w-[40rpx] h-[40rpx]"})]),n(B,{size:120,xEdge:"10",yEdge:"100"},{default:r((()=>[n(s,{class:F(["recorder-btn",{"recorder-btn--stop":!u(aa)&&!u(ra)}]),onClick:ca},{default:r((()=>[Ge.value?(o(),i(O,{key:0,style:V({width:`${Ke.width}px`,height:`${Ke.height}px`}),width:Ke.width*Ke.scale,height:Ke.height*Ke.scale,"canvas-id":Ke.id},null,8,["style","width","height","canvas-id"])):x("v-if",!0),u(aa)&&!Ge.value?(o(),i(h,{key:1,name:"mic",size:48})):u(ra)?(o(),i(h,{key:2,name:"pause-circle",size:60})):u(aa)?x("v-if",!0):(o(),i(h,{key:3,name:"mic-off",size:48}))])),_:1},8,["class"])])),_:1})]})),_:1},8,["style"])):(o(),i(s,{key:1,class:"h-screen w-screen flex flex-col items-center justify-center"},{default:r((()=>[n(q,{text:"该智能体暂未配置形象",mode:"page"})])),_:1}))])),_:1}),n(he,{show:me.value,"onUpdate:show":a[4]||(a[4]=e=>me.value=e),onConfirm:je},null,8,["show"])],64)}}}),[["__scopeId","data-v-c5617b36"]]);export{we as default};
