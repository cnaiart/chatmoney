import{d as e,M as a,o as t,c as l,w as o,K as s,b as n,f as i,r,a as u,j as c,s as d,R as v,u as p,A as m,L as f,G as _,x as y,H as h,aE as g,k as x,e as w,aO as b,n as k,aG as j,aH as C,g as V,m as T,F as A,l as D,t as z,N as L,aP as S,z as F,ad as P,aD as R,I as U,aw as $,p as B,aF as q,h as E,T as I}from"./index-9f08b835.js";import{_ as H}from"./page-meta.d2ccf398.js";import{_ as O}from"./u-navbar.9b578443.js";import{_ as N}from"./u-icon.f0423eb2.js";import{_ as J}from"./router-navigate.3e9d7fb5.js";import{_ as K}from"./chat-record-item.e0ff5f51.js";import{_ as M}from"./u-tag.d6be710f.js";import{_ as Y,a as G,b as Q}from"./dialog-poster.vue_vue_type_script_setup_true_lang.53970165.js";import{_ as W}from"./z-paging.5d396652.js";import{_ as X}from"./l-textarea.5288c032.js";import{_ as Z}from"./u-button.cd082997.js";import{_ as ee}from"./u-popup.6c89de8e.js";import{B as ae,C as te,D as le,E as oe,F as se,f as ne,m as ie,h as re,j as ue,i as ce,r as de,v as ve}from"./robot.8b2fb6bb.js";import{u as pe}from"./useLockFn.cde70c0d.js";import{_ as me}from"./popup.vue_vue_type_script_setup_true_lang.240bf415.js";import{_ as fe,a as _e}from"./context-popup.vue_vue_type_script_setup_true_lang.5d43fac0.js";import{u as ye}from"./text-item.75b27895.js";import{u as he,a as ge}from"./useRecorder.3e996450.js";import{u as xe}from"./useAudio.8d04ba62.js";import{_ as we}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-image.e6fb9592.js";import"./u-loading.15b95fef.js";import"./icon_copy.bacd4068.js";import"./useCopy.7659937f.js";import"./uni-file-picker.55c7ce72.js";import"./u-input.6dc4a2b4.js";import"./emitter.1571a5d9.js";import"./index.f8572cdb.js";import"./index.73309c03.js";import"./l-painter-image.bb294855.js";import"./l-painter.d7281161.js";import"./ua-markdown.f5ba7fba.js";import"./katex.30814119.js";import"./_commonjsHelpers.157f59fb.js";import"./mp-html.6ddc2dff.js";import"./index.c3709e84.js";import"./icon_copy.36709540.js";import"./chat.05123b79.js";import"./howler.bdae6f69.js";const be=e({__name:"index",props:{name:{type:String},modelValue:{type:Boolean}},emits:["update:modelValue"],setup(e,{emit:d}){const v=e,p=a({get:()=>v.modelValue,set:e=>{d("update:modelValue",e)}});return(e,a)=>{const d=r(u("u-icon"),N),v=c;return t(),l(v,{class:"bg-white flex justify-between items-center px-[20rpx] py-[24rpx]"},{default:o((()=>[s(e.$slots,"left"),n(v,{class:"flex items-center",onClick:a[0]||(a[0]=e=>p.value=!0)},{default:o((()=>[n(d,{name:"plus-circle",size:36}),n(v,{class:"flex-1 line-clamp-1 ml-[8rpx]"},{default:o((()=>[i("新建")])),_:1})])),_:1}),s(e.$slots,"right")])),_:3})}}});const ke=we(e({__name:"robot_chat",setup(e){const s=p(),we=F(),ke=P(),je=m(),Ce=f(),Ve=d(!1),Te=d([]),Ae=a((()=>ke.query.id)),{getSessionLists:De,sessionActive:ze,sessionAdd:Le,sessionEdit:Se,sessionLists:Fe,sessionDelete:Pe,sessionClear:Re,currentSession:Ue}=function(e){const t=d(0),l=d([]),o=async()=>{try{const a=await ae({robot_id:e});return l.value=a||[],0===t.value&&n(),l.value}catch(a){l.value=[],n()}},{lockFn:s}=pe((async()=>{await te({robot_id:e}),await o(),n()})),n=()=>{var e;t.value=(null==(e=l.value[0])?void 0:e.id)||0},i=a((()=>{var e;return(null==(e=l.value.find((e=>e.id===t.value)))?void 0:e.name)||""}));return{getSessionLists:o,sessionActive:t,sessionLists:l,sessionAdd:s,sessionEdit:async a=>{await se({...a,robot_id:e}),o()},sessionDelete:async a=>{(await v({title:"确定删除该会话？"})).confirm&&(await le({id:a,robot_id:e}),await o(),n())},sessionClear:async()=>{(await v({title:"确定清除所有会话？"})).confirm&&(await oe({robot_id:e}),await o(),n())},currentSession:i}}(Ae.value),$e=d(1),Be=a((()=>2===$e.value)),{pauseAll:qe}=ye(),Ee=d(0),Ie=_({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."}),He=e=>{2===$e.value&&(Ee.value=e)},Oe=d(!1),Ne=d(0),Je=d(!1),Ke=d(0),Me=d(0),Ye=d(!0),Ge=_({id:"audio-canvas",width:100,height:30,minHeight:5,scale:2}),Qe=f(),{render:We,stopRender:Xe,draw:Ze}=he(Ge),{start:ea,stop:aa,isRecording:ta,authorize:la,close:oa}=ge({onstart(){Je.value=!1,Ne.value=Date.now()},async onstop(e){if(Xe(),setTimeout((()=>{Ze(new Float64Array(new Array(128).fill(0)),0)}),10),Oe.value){Oe.value=!1,He(3);try{const a=await ue(e.tempFilePath);if(!a.text)return void(Ye.value&&He(2));Pa(a.text,"voice")}catch(a){Ye.value&&He(1)}}},ondata(e){We(e);const a=Date.now();e.powerLevel>15&&(clearTimeout(Ke.value),Ee.value=2,Je.value=!0,Ne.value=a,Ke.value=setTimeout((()=>{Oe.value=!0,clearTimeout(Me.value),aa()}),2e3)),a-Ne.value>=5e3&&Je.value}}),{play:sa,pause:na,isPlaying:ia}=xe({onstart(){Ee.value=4,da.value&&(da.value=!1,aa())},onstop(){var e;Me.value=setTimeout((()=>{va()}),1e3*(null==(e=_a.value.digital)?void 0:e.idle_time)||0),Ye.value?He(2):He(1)},onerror(){He(1)}}),ra=async e=>{const{url:a}=await ve(e);return a},ua=async()=>{[4,3].includes(Ee.value)||(ta.value?(Ye.value=!1,aa(),He(1)):(Ye.value=!0,He(2)))},ca=d(""),da=d(!1),va=async()=>{if(2!==$e.value)return Promise.reject();if(!_a.value.is_digital||!_a.value.digital_id||_a.value.is_disable)return Promise.reject();if(ca.value||(ca.value=await ra({type:3,record_id:_a.value.id})),!ca.value)return Promise.reject();da.value=!0;const e=Date.now();Te.value.push({type:2,typing:!1,content:_a.value.digital.idle_reply,key:e}),await I(),Ta(),sa(ca.value)};y($e,(async e=>{if(1===e)na(),oa(),Ee.value=0,clearTimeout(Me.value);else{Ye.value=!0,await la(),Ze(null,0);try{await va()}catch(a){He(2)}Ta()}})),y(Ee,(e=>{if(2===e)(async()=>{ta.value||2!==$e.value||ea()})()}));const pa=_({show:!1,data:[]}),ma=_({show:!1,data:[]}),fa=d(!1),_a=d({}),ya=d(""),ha=d(""),ga=()=>{if(!je.isLogin)return Ba();Ta()},xa=f();let wa=0;const ba=async(e,a)=>{var t,l;try{const{lists:l=[],count:o}=await ne({category_id:ze.value,robot_id:Ae.value,page_size:a/2,page_no:e});if(null==(t=xa.value)||t.complete(l.reverse()),0===o?setTimeout((()=>{var e;null==(e=xa.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{Ta()}),100),2===$e.value&&3==Ee.value){const e=l[0];e&&e.id!==wa&&(wa=e.id,(async e=>{try{const a=await ra({type:2,record_id:e});sa(a)}catch(a){He(1)}})(wa))}}catch(o){null==(l=xa.value)||l.complete(!1)}},ka=d(!1),ja=e=>{console.log(e),e.height>0?ka.value=!0:ka.value=!1},Ca=()=>{ka.value=!1};y(ze,(e=>{console.log(e),setTimeout((()=>{var a,t;e?null==(a=xa.value)||a.reload():(null==(t=xa.value)||t.complete([]),setTimeout((()=>{var e;null==(e=xa.value)||e.scrollToTop(!1)}),100))}),10)}),{immediate:!0});const{lockFn:Va}=pe((async()=>{var e;if(!je.isLogin)return Ba();(await v({title:"温馨提示",content:"确定清空对话？"})).cancel||(La(),await ce({robot_id:Ae.value,category_id:ze.value}),null==(e=xa.value)||e.reload())})),Ta=async()=>{var e;null==(e=xa.value)||e.scrollToBottom(!1)},Aa=d(!1);let Da=null;const za=d([]),La=()=>{null==Da||Da.cancel(),setTimeout((()=>{ya.value=""}))},Sa=d({}),{pauseAll:Fa}=ye(),{lockFn:Pa}=pe((async(e,a="text")=>{if(Ve.value=!1,!je.isLogin)return Ba();if(Aa.value)return;const t=e||ya.value;if(t){0===ze.value&&await Le(),"新的会话"===Ue.value&&await Se({id:ze.value,name:t}),xa.value.addChatRecordData({type:1,content:t}),Sa.value={type:2,loading:!0,content:[],id:Date.now()},xa.value.addChatRecordData(Sa.value),ha.value=ya.value,ya.value="";try{Aa.value=!0,He(3),await de({cate_id:ze.value,robot_id:Ae.value,question:t,stream:!0},{onstart(e){Da=e,Fa(),ya.value=""},onmessage(e){e.trim().split("data:").forEach((async e=>{var a,t,l,o;if(""!==e)try{const n=JSON.parse(e),{object:i,choices:r,error:u}=n;if(u){const{message:e,code:a}=u;return e&&uni.$u.toast(e),void Te.value.splice(0,2)}const c=null==(t=null==(a=r[0])?void 0:a.delta)?void 0:t.content;switch(i){case"chat":Sa.value.content||(Sa.value.content=""),Sa.value.content+=c;break;case"question":za.value=JSON.parse(null==(o=null==(l=r[0])?void 0:l.delta)?void 0:o.content);break;case"image":case"video":case"file":{const e=`${i}s`;try{const a=JSON.parse(c);Sa.value[e]=a}catch(s){console.error(s)}}}}catch(n){}}))},onclose(){Aa.value=!1,setTimeout((()=>{var e;null==(e=xa.value)||e.reload(),je.getUser()}),600)}})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==q.ABORT&&Te.value.splice(0,2),"text"==a&&(ya.value=ha.value),Aa.value=!1}}})),Ra=d(!1),Ua=_({_index:-1,robot_id:Ae.value,record_id:-1,content:""}),$a=async()=>{try{await ie(Ua),Ra.value=!1,Ua.content="",Te.value[Ua._index].is_feedback=1}catch(e){console.log("反馈提交失败--\x3e",e)}},Ba=()=>{we.navigateTo({path:"/pages/login/login"})};return h((async()=>{De(),(async()=>{_a.value=await re({id:Ae.value})})()})),g((()=>{La()})),(e,a)=>{const d=r(u("page-meta"),H),v=r(u("u-navbar"),O),p=c,m=r(u("u-icon"),N),f=r(u("router-navigate"),J),_=R,y=r(u("chat-record-item"),K),h=r(u("u-tag"),M),g=E,F=U,P=r(u("chat-input"),G),q=r(u("z-paging"),W),I=r(u("l-watermark"),Q),ae=$,te=r(u("l-textarea"),X),le=r(u("u-button"),Z),oe=r(u("u-popup"),ee);return t(),x(A,null,[n(d,{"page-style":e.$theme.pageStyle},null,8,["page-style"]),n(p,{class:"h-full flex flex-col"},{default:o((()=>[n(p,null,{default:o((()=>[n(v,{title:_a.value.name,"title-color":"#333","title-bold":!0},null,8,["title"])])),_:1}),n(p,{class:"flex-1 min-h-0 flex flex-col",style:{transform:"scaleY(1)"}},{default:o((()=>[n(p,null,{default:o((()=>[n(be,{modelValue:fa.value,"onUpdate:modelValue":a[0]||(a[0]=e=>fa.value=e),name:w(Ue)},b({_:2},[_a.value.is_digital?{name:"right",fn:o((()=>[n(f,{to:{path:"/packages/pages/digital_chat/digital_chat",query:{id:w(Ae),cateId:w(ze)}},onClick:w(qe)},{default:o((()=>[n(p,{class:"flex items-center"},{default:o((()=>[n(p,{class:"mr-[10rpx]"},{default:o((()=>[i(" 形象对话 ")])),_:1}),n(m,{name:"arrow-rightward"})])),_:1})])),_:1},8,["to","onClick"])])),key:"0"}:void 0]),1032,["modelValue","name"])])),_:1}),n(p,{class:"flex-1 min-h-0 relative",style:k({background:w(Be)?_a.value.digital_bg:""})},{default:o((()=>[w(Be)?(t(),l(p,{key:0,class:"absolute inset-0"},{default:o((()=>{var e,a;return[j(n(_,{class:"h-full w-full",src:null==(e=_a.value.digital)?void 0:e.vertical_stay_video,autoplay:"",muted:"",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"contain"},null,8,["src"]),[[C,!w(ia)]]),j(n(_,{class:"h-full w-full",src:null==(a=_a.value.digital)?void 0:a.vertical_talk_video,autoplay:"",muted:"",loop:"",controls:!1,"show-play-btn":!1,"show-center-play-btn":!1,"show-fullscreen-btn":!1,"object-fit":"contain"},null,8,["src"]),[[C,w(ia)]])]})),_:1})):V("v-if",!0),n(p,{class:"h-full flex flex-col"},{default:o((()=>[n(I,{class:"flex-1 min-h-0",content:w(s).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:o((()=>[n(q,{ref_key:"pagingRef",ref:xa,modelValue:Te.value,"onUpdate:modelValue":a[2]||(a[2]=e=>Te.value=e),"use-chat-record-mode":"",auto:!1,"safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,onQuery:ba,fixed:!1,onKeyboardHeightChange:ja,onHidedKeyboard:Ca},{empty:o((()=>[n(p,{class:"w-full min-h-full pt-[40rpx]"},{default:o((()=>[_a.value.welcome_introducer?(t(),l(y,{key:0,class:T({"opacity-50":w(Be)}),type:"left",content:_a.value.welcome_introducer,avatar:_a.value.icons?_a.value.icons:_a.value.image,showCopyBtn:!1,onClickLink:w(Pa)},null,8,["class","content","avatar","onClickLink"])):V("v-if",!0)])),_:1})])),bottom:o((()=>[n(p,{class:T({" bg-white":!w(Be)})},{default:o((()=>[n(P,{class:T({"!bg-[transparent]":!0}),modelValue:ya.value,"onUpdate:modelValue":a[1]||(a[1]=e=>ya.value=e),loading:Aa.value||3===Ee.value,"show-stop":Aa.value,onSend:w(Pa),onPause:La,onFocus:ga,onClear:w(Va)},{actions:o((()=>[n(F,{class:"w-full whitespace-nowrap","scroll-x":""},{default:o((()=>[(t(!0),x(A,null,D(_a.value.menus,((e,a)=>(t(),l(p,{class:"menus bg-page px-[30rpx] rounded-full mr-[20rpx] py-[10rpx] inline-block",key:a,onClick:a=>w(Pa)(e.keyword)},{default:o((()=>[i(z(e.keyword),1)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1},8,["modelValue","loading","show-stop","onSend","onClear"]),V(' <view\n                                        v-if="robotInfo.copyright"\n                                        class="pb-[20rpx] text-center text-content"\n                                    >\n                                        {{ robotInfo.copyright }}\n                                    </view> ')])),_:1},8,["class"])])),default:o((()=>[n(p,{class:"scroll-view-content pb-[40rpx]",ref_key:"contentRef",ref:Ce},{default:o((()=>[(t(!0),x(A,null,D(Te.value,((e,a)=>(t(),l(p,{key:`${e.id} + ${a} + ''`,style:{transform:"scaleY(-1)"}},{default:o((()=>[n(p,{class:"chat-record mt-[20rpx] pb-[40rpx]"},{default:o((()=>[1==e.type?(t(),l(y,{key:0,type:"right",content:e.content,avatar:w(je).userInfo.avatar,showCopyBtn:!0,class:T({"opacity-50":w(Be)})},null,8,["content","avatar","class"])):V("v-if",!0),2==e.type?(t(),l(y,{key:1,class:T({"opacity-50":w(Be)}),"record-id":e.id,type:"left",content:e.content,loading:e.loading,avatar:_a.value.icons?_a.value.icons:_a.value.image,index:a,chatType:2,time:e.create_time,showCopyBtn:!0,images:e.images,files:e.files,videos:e.videos,showVoiceBtn:!0,"model-name":e.model,"show-poster":!0,onPoster:a=>(async e=>{const a=Te.value.filter((a=>a.id==e));2==a.length?Qe.value.initPosterData({title:a[1].content,content:a[0].content}):uni.$u.toast("上下文数据不对～")})(e.id)},{btn:o((()=>[n(p,{class:"flex items-center"},{default:o((()=>{var a,s;return[_a.value.is_show_quote&&(null==(a=e.quotes)?void 0:a.length)?(t(),l(p,{key:0,class:"text-content text-sm flex items-center mr-[20rpx] mt-[16rpx]",onClick:a=>{return t=e.quotes,ma.show=!0,void(ma.data=t);var t}},{default:o((()=>{var a;return[i(z(null==(a=e.quotes)?void 0:a.length)+"条引用 ",1)]})),_:2},1032,["onClick"])):V("v-if",!0),_a.value.is_show_context&&(null==(s=e.context)?void 0:s.length)?(t(),l(p,{key:1,class:"text-content text-sm flex items-center mr-[20rpx] mt-[16rpx]",onClick:a=>{return t=e.context,pa.show=!0,void(pa.data=t);var t}},{default:o((()=>{var a;return[i(z(null==(a=e.context)?void 0:a.length)+"条上下文 ",1)]})),_:2},1032,["onClick"])):V("v-if",!0)]})),_:2},1024)])),sub_actions:o((()=>[e.create_time?(t(),l(p,{key:0,class:"ml-[86rpx] mt-2"},{default:o((()=>[n(h,{text:e.is_feedback?"已反馈":"反馈",type:e.is_feedback?"info":"primary",size:"mini",style:{"--color-primary-light-3":"transparent","--color-info-light-3":"transparent"},onClick:t=>((e,a)=>{1!==Te.value[a].is_feedback&&(Ua.record_id=e.id,Ua._index=a,Ra.value=!0)})(e,a)},null,8,["text","type","onClick"])])),_:2},1024)):V("v-if",!0),0!==a||Aa.value?V("v-if",!0):(t(),l(p,{key:1,class:"flex flex-col",style:{"margin-left":"84rpx"}},{default:o((()=>[(t(!0),x(A,null,D(za.value.length?za.value:e.correlation,((e,a)=>(t(),l(p,{key:a,class:"inline-flex items-center rounded-md bg-white cursor-pointer mt-[20rpx]",style:{padding:"16rpx 24rpx",width:"fit-content"},onClick:B((a=>w(Pa)(e)),["stop"])},{default:o((()=>[n(g,{class:"mr-1 text-base text-content"},{default:o((()=>[i(z(e),1)])),_:2},1024),n(m,{name:"arrow-rightward",color:"#999",size:"30"})])),_:2},1032,["onClick"])))),128))])),_:2},1024))])),_:2},1032,["class","record-id","content","loading","avatar","index","time","images","files","videos","model-name","onPoster"])):V("v-if",!0)])),_:2},1024)])),_:2},1024)))),128))])),_:1},512)])),_:1},8,["modelValue"])])),_:1},8,["content","font"]),n(p,{class:"relative"},{default:o((()=>[w(Be)?(t(),l(p,{key:0,class:T(["recorder-btn",{"recorder-btn--stop":!w(ta)}]),onClick:ua},{default:o((()=>[w(ta)?(t(),l(m,{key:0,name:"mic",size:50})):(t(),l(m,{key:1,name:"mic-off",size:50}))])),_:1},8,["class"])):V("v-if",!0),w(Be)?(t(),l(p,{key:1,class:"mb-[100rpx]"},{default:o((()=>[n(p,{class:"flex flex-col justify-center items-center text-white my-[20rpx] text-xs"},{default:o((()=>[n(ae,{style:k({width:`${Ge.width}px`,height:`${Ge.height}px`}),"canvas-id":Ge.id},null,8,["style","canvas-id"]),n(p,null,{default:o((()=>[i(z(Ie[Ee.value]),1)])),_:1})])),_:1})])),_:1})):V("v-if",!0)])),_:1})])),_:1})])),_:1},8,["style"]),V("  会话弹窗  "),n(me,{show:fa.value,"onUpdate:show":a[3]||(a[3]=e=>fa.value=e),modelValue:w(ze),"onUpdate:modelValue":a[4]||(a[4]=e=>L(ze)?ze.value=e:null),lists:w(Fe),onAdd:w(Le),onClear:w(Re),onDelete:w(Pe),onEdit:w(Se)},null,8,["show","modelValue","lists","onAdd","onClear","onDelete","onEdit"])])),_:1}),n(fe,S(ma,{show:ma.show,"onUpdate:show":a[5]||(a[5]=e=>ma.show=e)}),null,16,["show"]),n(_e,S(pa,{show:pa.show,"onUpdate:show":a[6]||(a[6]=e=>pa.show=e)}),null,16,["show"]),V(" 内容反馈 "),n(oe,{modelValue:Ra.value,"onUpdate:modelValue":a[8]||(a[8]=e=>Ra.value=e),"safe-area-inset-bottom":"",closeable:"","border-radius":"16",mode:"center"},{default:o((()=>[n(p,{class:"flex flex-col",style:{width:"600rpx"}},{default:o((()=>[n(p,{class:"text-xl mx-[20rpx] py-[28rpx] font-bold border-b border-solid border-light border-0"},{default:o((()=>[i(" 问题反馈 ")])),_:1}),n(p,{class:"flex-1 min-h-0 px-[20rpx] pb-[30rpx]"},{default:o((()=>[n(p,{class:"py-[20rpx]"},{default:o((()=>[n(te,{modelValue:Ua.content,"onUpdate:modelValue":a[7]||(a[7]=e=>Ua.content=e),placeholder:"描述一下你遇到了什么问题"},null,8,["modelValue"])])),_:1}),n(le,{type:"primary",onClick:$a},{default:o((()=>[i("提交反馈")])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),V("  生产对话海报  "),n(Y,{ref_key:"posterRef",ref:Qe},null,512)])),_:1})],64)}}}),[["__scopeId","data-v-ea7d6868"]]);export{ke as default};
