"use strict";const e=require("../../../../common/vendor.js"),o="chooseAndUploadFile:ok",i="chooseAndUploadFile:fail";function t(e,o){return e.tempFiles.forEach(((e,i)=>{e.name||(e.name=e.path.substring(e.path.lastIndexOf("/")+1)),o&&(e.fileType=o),e.cloudPath=Date.now()+"_"+i+e.name.substring(e.name.lastIndexOf("."))})),e.tempFilePaths||(e.tempFilePaths=e.tempFiles.map((e=>e.path))),e}function s(e,{onChooseFile:i,onUploadProgress:t}){return e.then((e=>{if(i){const o=i(e);if(void 0!==o)return Promise.resolve(o).then((o=>void 0===o?e:o))}return e})).then((e=>!1===e?{errMsg:o,tempFilePaths:[],tempFiles:[]}:e))}exports.chooseAndUploadFile=function(o={type:"all"}){return"image"===o.type?s(function(o){const{count:s,sizeType:n=["original","compressed"],sourceType:r,extension:l}=o;return new Promise(((o,a)=>{e.index.chooseImage({count:s,sizeType:n,sourceType:r,extension:l,success(e){o(t(e,"image"))},fail(e){a({errMsg:e.errMsg.replace("chooseImage:fail",i)})}})}))}(o),o):"video"===o.type?s(function(o){const{camera:s,compressed:n,maxDuration:r,sourceType:l,extension:a}=o;return new Promise(((o,c)=>{e.index.chooseVideo({camera:s,compressed:n,maxDuration:r,sourceType:l,extension:a,success(e){const{tempFilePath:i,duration:s,size:n,height:r,width:l}=e;o(t({errMsg:"chooseVideo:ok",tempFilePaths:[i],tempFiles:[{name:e.tempFile&&e.tempFile.name||"",path:i,size:n,type:e.tempFile&&e.tempFile.type||"",width:l,height:r,duration:s,fileType:"video",cloudPath:""}]},"video"))},fail(e){c({errMsg:e.errMsg.replace("chooseVideo:fail",i)})}})}))}(o),o):s(function(o){const{count:s,extension:n}=o;return new Promise(((o,r)=>{let l=e.index.chooseFile;if(void 0!==e.wx$1&&"function"==typeof e.wx$1.chooseMessageFile&&(l=e.wx$1.chooseMessageFile),"function"!=typeof l)return r({errMsg:i+" 请指定 type 类型，该平台仅支持选择 image 或 video。"});l({type:"all",count:s,extension:n,success(e){o(t(e))},fail(e){r({errMsg:e.errMsg.replace("chooseFile:fail",i)})}})}))}(o),o)},exports.uploadCloudFiles=function(o,i=5,t){const s=(o=JSON.parse(JSON.stringify(o))).length;let n=0,r=this;return new Promise((l=>{for(;n<i;)a();function a(){let i=n++;if(i>=s)return void(!o.find((e=>!e.url&&!e.errMsg))&&l(o));const c=o[i],p=r.files.findIndex((e=>e.uuid===c.uuid));c.url="",delete c.errMsg,e.Ls.uploadFile({filePath:c.path,cloudPath:c.cloudPath,fileType:c.fileType,onUploadProgress:e=>{e.index=p,t&&t(e)}}).then((e=>{c.url=e.fileID,c.index=p,i<s&&a()})).catch((e=>{c.errMsg=e.errMsg||e.message,c.index=p,i<s&&a()}))}}))};
