"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../api/chat.js"),a=require("../../../../hooks/useLockFn.js"),t=require("../../../../stores/user.js"),n=require("../../../../stores/app.js"),s=require("../../../../enums/requestEnums.js"),l=require("./components/useSessionList.js"),u=require("../../../../hooks/useAudioPlay.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../utils/request/cancel.js"),require("../../../../router/index.js"),require("../../../../utils/cache.js"),require("../../../../enums/constantEnums.js"),require("../../../../config/index.js"),require("../../../../utils/client.js"),require("../../../../enums/appEnums.js"),require("../../../../api/user.js"),require("../../../../utils/auth.js"),require("../../../../utils/unique-id.js"),require("../../../../api/app.js"),require("../../../../api/shop.js"),!Array){(e.resolveComponent("model-picker")+e.resolveComponent("u-icon")+e.resolveComponent("chat-record-item")+e.resolveComponent("chat-input")+e.resolveComponent("z-paging")+e.resolveComponent("l-watermark"))()}Math||((()=>"../../../../components/model-picker/model-picker.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/chat-record-item/chat-record-item.js")+r+(()=>"../../../../components/chat-input/chat-input.js")+(()=>"../../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../../uni_modules/lime-watermark/components/l-watermark/l-watermark.js")+i+c)();const i=()=>"../../../components/session/popup.js",r=()=>"./components/problem-example.js",c=()=>"./components/problem-example-popup.js",p=e.defineComponent({__name:"chat",props:{active:{default:0}},emits:["active"],setup(i,{expose:r,emit:c}){var p;const v=n.useAppStore(),d=e.useRouter(),m=t.useUserStore();e.shallowRef();const g=e.ref(!1),h=e.ref([]),f=e.ref(""),{getSessionLists:w,initSessionActive:y,sessionActive:j,sessionAdd:q,sessionEdit:C,sessionLists:k,sessionDelete:T,sessionClear:_,currentSession:x}=l.useSessionList(),L=e.ref(!1),S=e.ref(!1),b=e.ref([]),R=e.ref(""),A=e.ref(""),z=()=>{if(!m.isLogin)return W();K()},E=e.shallowRef();(null==(p=v.getChatConfig)?void 0:p.is_reopen)&&(q(),v.getChatConfig.is_reopen=0);const F=async(e,a)=>{var t,n;try{const{lists:n=[],count:s}=await o.getChatRecord({type:1,category_id:j.value,page_size:a/2,page_no:e});null==(t=E.value)||t.complete(n.reverse()),0===s?setTimeout((()=>{var e;null==(e=E.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{K()}),100)}catch(s){null==(n=E.value)||n.complete(!1)}},$=e.ref(!1),B=e=>{e.height>0?$.value=!0:$.value=!1},U=()=>{$.value=!1};e.watch(j,(e=>{console.log(e),setTimeout((()=>{var o,a;e?null==(o=E.value)||o.reload():(null==(a=E.value)||a.complete([]),setTimeout((()=>{var e;null==(e=E.value)||e.scrollToTop(!1)}),100))}),10)}),{immediate:!0});const D=e.reactive({show:!1,data:{url:"",name:"",type:"image"}}),I=e=>{D.show=!!e.support_image,D.show||(D.data.url="")},{lockFn:M}=a.useLockFn((async()=>{var a;if(!m.isLogin)return W();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(O(),await o.cleanChatRecord({type:1,category_id:j.value}),null==(a=E.value)||a.reload())})),V=e.ref(-1),{lockFn:H}=a.useLockFn((async e=>{if(P.value)return;const o=h.value[e],a=h.value.findLast((({id:e})=>e===o.id));a&&(V.value=o.id,h.value.splice(e,2),Q(a.content))})),K=async()=>{var e;null==(e=E.value)||e.scrollToBottom(!1)},P=e.ref(!1);let J=null;const O=()=>{null==J||J.abort(),setTimeout((()=>{R.value=""}))},G=e.ref({}),{pauseAll:N}=u.useAudioPlay(),{lockFn:Q}=a.useLockFn((async(a,t)=>{if(console.log(t),g.value=!1,!m.isLogin)return W();if(P.value)return;const n=a||R.value;if(n){0===j.value&&await q(),"新的会话"===x.value&&await C({id:j.value,name:n}),E.value.addChatRecordData({type:1,content:n,files_plugin:[{...D.data}]}),G.value={type:2,loading:!0,content:[],id:Date.now()},E.value.addChatRecordData(G.value),A.value=R.value,R.value="";try{P.value=!0,await o.chatSendText({type:1,other_id:j.value,question:n,model:f.value,file:D.data.url,...t},{onstart(e){J=e,N(),R.value=""},onmessage(o){o.trim().split("data:").forEach((async o=>{var a,t,n;if(""!==o)try{const s=JSON.parse(o),{object:l,choices:u,error:i}=s;if(i){console.log(i);const{message:o,code:a}=i;if(1100===a)if(v.getIsShowRecharge){const{cancel:o}=await e.index.showModal({title:"温馨提示",content:`${v.getTokenUnit}数量已用完，请前往充值`});if(o)return;d.navigateTo({path:"/packages/pages/recharge/recharge"})}else e.index.$u.toast(`${v.getTokenUnit}数量已用完。请联系客服增加`);else o&&e.index.$u.toast(o);return R.value=A.value,void h.value.splice(0,2)}switch(l){case"chat":{const e=null==(a=u[0])?void 0:a.index,o=null==(n=null==(t=u[0])?void 0:t.delta)?void 0:n.content;G.value.content[e]||(G.value.content[e]=""),G.value.content[e]+=o;break}case"finish":D.data.url=""}}catch(s){}}))},async onclose(){-1!==V.value&&G.value.content.length&&(await o.cleanChatRecord({type:1,id:V.value}),V.value=-1),P.value=!1,setTimeout((()=>{var e;null==(e=E.value)||e.reload(),m.getUser()}),500)}})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==s.RequestErrMsgEnum.ABORT&&h.value.splice(0,2),R.value=A.value,P.value=!1}}})),W=()=>{d.navigateTo({path:"/pages/login/login"})};return e.onShow((async()=>{await w(),y(),(async()=>{b.value=await o.getSamplesLists()})(),setTimeout((()=>{var o;e.index.onKeyboardHeightChange(null==(o=E.value)?void 0:o._handleKeyboardHeightChange)}),100)})),e.onUnmounted((()=>{O()})),r({showPopup:L}),(o,a)=>e.e({a:e.o(I),b:e.o((e=>f.value=e)),c:e.p({sub_id:f.value}),d:e.f(h.value,((o,a,t)=>e.e(0===i.active?e.e({a:2==o.type&&0===a},2==o.type&&0===a?{b:"3de04224-4-"+t+",3de04224-3-"+t,c:e.p({name:"reload",size:"26"}),d:e.o((o=>e.unref(H)(a)),`${o.id} + ${a} + ''`)}:{},{e:"3de04224-3-"+t+",3de04224-1",f:e.p({"record-id":o.id,type:1==o.type?"right":"left",content:o.content,loading:o.loading,"files-plugin":o.files_plugin,avatar:1==o.type?e.unref(m).userInfo.avatar:e.unref(v).getChatConfig.chat_logo,index:a,time:2==o.type?o.create_time:"",showCopyBtn:!0,showVoiceBtn:2==o.type,"model-name":o.model})}):{},{g:`${o.id} + ${a} + ''`}))),e:0===i.active,f:b.value.length},b.value.length?{g:e.o(e.unref(Q)),h:e.o((e=>S.value=!0)),i:e.p({data:b.value})}:{},{j:e.unref(m).isLogin},e.unref(m).isLogin?{k:e.t(e.unref(m).userInfo.balance),l:e.t(e.unref(v).getTokenUnit)}:{},{m:e.o(e.unref(Q)),n:e.o(O),o:e.o(z),p:e.o(e.unref(M)),q:e.o((o=>e.unref(Q)("继续"))),r:e.o((e=>R.value=e)),s:e.o((e=>D.data=e)),t:e.p({loading:P.value,showStop:P.value,"show-file-upload":D.show,showContinue:h.value.length,safeAreaInsetBottom:!0,modelValue:R.value,"file-plugin":D.data}),v:e.sr(E,"3de04224-1,3de04224-0",{k:"pagingRef"}),w:e.o(F),x:e.o(B),y:e.o(U),z:e.o((e=>h.value=e)),A:e.p({"use-chat-record-mode":!0,fixed:!1,height:"100%",auto:!1,"safe-area-inset-bottom":!1,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,modelValue:h.value}),B:e.p({content:e.unref(v).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}}),C:e.o(e.unref(q)),D:e.o(e.unref(_)),E:e.o(e.unref(T)),F:e.o(e.unref(C)),G:e.o((e=>L.value=e)),H:e.o((o=>e.isRef(j)?j.value=o:null)),I:e.p({lists:e.unref(k),show:L.value,modelValue:e.unref(j)}),J:e.o((o=>e.unref(Q)(o))),K:e.o((e=>S.value=e)),L:e.p({data:b.value,modelValue:S.value})})}});wx.createComponent(p);
