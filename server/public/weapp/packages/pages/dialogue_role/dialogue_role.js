"use strict";const e=require("../../../common/vendor.js"),a=require("../../../api/chat.js"),t=require("../../../api/role.js"),o=require("../../../hooks/useLockFn.js"),n=require("../../../stores/user.js"),r=require("../../../stores/app.js"),l=require("../../../hooks/useShareMessage.js"),s=require("../../../enums/requestEnums.js"),u=require("../../../hooks/useAudioPlay.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../api/app.js"),require("../../../api/shop.js"),require("../../../utils/util.js"),require("../../../stores/navigationBarTitle.js"),require("../../../mixins/share.js"),require("../../../api/task_reward.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("chat-record-item")+e.resolveComponent("chat-input")+e.resolveComponent("z-paging")+e.resolveComponent("l-watermark"))()}Math||(i+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../components/chat-record-item/chat-record-item.js")+(()=>"../../../components/chat-input/chat-input.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/lime-watermark/components/l-watermark/l-watermark.js"))();const i=()=>"../../../components/model-picker/model-picker.js",c=e.defineComponent({__name:"dialogue_role",setup(i){const{useShare:c,resolveOptions:d,removeMixinShare:v}=l.useShareMessage(),p=r.useAppStore(),g=e.useRoute(),h=e.useRouter(),m=n.useUserStore();e.shallowRef();const f=e.ref(!1),w=e.ref(0),y=e.ref({image:"",tips:"",name:""}),q=e.ref(""),j=e.ref([]),k=e.ref(""),C=e.ref(""),_=()=>{L()},x=e.reactive({show:!1,data:{url:"",name:"",type:"image"}}),T=e=>{x.show=!!e.support_image,x.show||(x.data.url="")},R=e.shallowRef(),S=async(e,t)=>{var o,n;try{const{lists:n=[],count:r}=await a.getChatRecord({type:3,other_id:w.value,page_size:t/2,page_no:e});null==(o=R.value)||o.complete(n.reverse()),0===r?setTimeout((()=>{var e;null==(e=R.value)||e.scrollToTop(!1)}),200):1===t&&setTimeout((()=>{L()}),100)}catch(r){null==(n=R.value)||n.complete(!1)}},B=e.ref(!1),$=e=>{e.height>0?B.value=!0:B.value=!1},b=()=>{B.value=!1},{lockFn:M}=o.useLockFn((async()=>{var t;if(!m.isLogin)return V();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(E(),await a.cleanChatRecord({type:3,other_id:w.value}),null==(t=R.value)||t.reload())})),z=e.ref(-1),{lockFn:A}=o.useLockFn((async e=>{if(U.value)return;const a=j.value[e],t=j.value.findLast((({id:e})=>e===a.id));t&&(z.value=a.id,j.value.splice(e,2),O(t.content))})),L=async()=>{var e;null==(e=R.value)||e.scrollToBottom(!1)},U=e.ref(!1);let F=null;const E=()=>{null==F||F.abort(),setTimeout((()=>{k.value=""}))},D=e.ref({}),{pauseAll:I}=u.useAudioPlay(),V=()=>{h.navigateTo({path:"/pages/login/login"})},{lockFn:O}=o.useLockFn((async t=>{if(f.value=!1,!m.isLogin)return V();if(U.value)return;const o=t||k.value;if(o){R.value.addChatRecordData({type:1,content:o,files_plugin:[{...x.data}]}),D.value={type:2,loading:!0,content:[],id:Date.now()},R.value.addChatRecordData(D.value),C.value=k.value,k.value="";try{U.value=!0,await a.chatSendText({type:3,other_id:w.value,question:o,model:q.value,file:x.data.url},{onstart(e){F=e,I(),k.value=""},onmessage(a){a.trim().split("data:").forEach((async a=>{var t,o,n;if(""!==a)try{const r=JSON.parse(a),{object:l,choices:s,error:u}=r;if(u){console.log(u);const{message:a,code:t}=u;if(1100===t)if(p.getIsShowRecharge){const{cancel:a}=await e.index.showModal({title:"温馨提示",content:`${p.getTokenUnit}数量已用完，请前往充值`});if(a)return;h.navigateTo({path:"/packages/pages/recharge/recharge"})}else e.index.$u.toast(`${p.getTokenUnit}数量已用完。请联系客服增加`);else a&&e.index.$u.toast(a);return k.value=C.value,void j.value.splice(0,2)}switch(l){case"chat":{const e=null==(t=s[0])?void 0:t.index,a=null==(n=null==(o=s[0])?void 0:o.delta)?void 0:n.content;D.value.content[e]||(D.value.content[e]=""),D.value.content[e]+=a;break}case"finish":console.log("终端"),x.data.url=""}}catch(r){}}))},async onclose(){-1!==z.value&&D.value.content.length&&(await a.cleanChatRecord({type:1,id:z.value}),z.value=-1),U.value=!1,setTimeout((()=>{var e;null==(e=R.value)||e.reload(),m.getUser()}),500)}})}catch(n){console.log("发送消息失败=>",n),n.errMsg!==s.RequestErrMsgEnum.ABORT&&j.value.splice(0,2),k.value=C.value,U.value=!1}}}));return e.onMounted((async()=>{const{id:e}=g.query;w.value=e,await(async()=>{try{y.value=await t.getRoleDetail({id:w.value}),c({desc:y.value.describe,title:y.value.name,imageUrl:y.value.image})}catch(e){console.log("获取角色错误=>",e)}})()})),e.onUnmounted((()=>{E()})),v(),e.onShareAppMessage((async()=>await d({title:y.value.name,imageUrl:y.value.image}))),(a,t)=>e.e({a:a.$theme.navColor,b:a.$theme.navBgColor,c:a.$theme.pageStyle,d:e.o(T),e:e.o((e=>q.value=e)),f:e.p({hasHiddenUnit:!1,sub_id:q.value}),g:e.f(j.value,((a,t,o)=>e.e({a:2==a.type&&0===t},2==a.type&&0===t?{b:"31a20e31-4-"+o+",31a20e31-3-"+o,c:e.p({name:"reload",size:"26"}),d:e.o((a=>e.unref(A)(t)),`${a.id} + ${t} + ''`)}:{},{e:"31a20e31-3-"+o+",31a20e31-2",f:e.p({"record-id":a.id,type:1==a.type?"right":"left",content:a.content,loading:a.loading,avatar:1==a.type?e.unref(m).userInfo.avatar:y.value.image,index:t,time:2==a.type?a.create_time:"",showCopyBtn:!0,showVoiceBtn:2==a.type,"files-plugin":a.files_plugin,"model-name":a.model}),g:`${a.id} + ${t} + ''`}))),h:e.o((a=>e.unref(O)(a))),i:e.p({type:"left",content:y.value.tips,loading:!1,avatar:y.value.image,index:0,showCollectBtn:!1,showCopyBtn:!1,showVoiceBtn:!1}),j:e.unref(m).isLogin},e.unref(m).isLogin?{k:e.t(e.unref(m).userInfo.balance),l:e.t(e.unref(p).getTokenUnit)}:{},{m:e.o(e.unref(O)),n:e.o(E),o:e.o(_),p:e.o(e.unref(M)),q:e.o((a=>e.unref(O)("继续"))),r:e.o((e=>k.value=e)),s:e.o((e=>x.data=e)),t:e.p({loading:U.value,showStop:U.value,safeAreaInsetBottom:!0,showContinue:j.value.length,"show-file-upload":x.show,modelValue:k.value,"file-plugin":x.data}),v:e.sr(R,"31a20e31-2,31a20e31-1",{k:"pagingRef"}),w:e.o(S),x:e.o($),y:e.o(b),z:e.o((e=>j.value=e)),A:e.p({"use-chat-record-mode":!0,fixed:!1,height:"100%",auto:!0,"safe-area-inset-bottom":!1,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,modelValue:j.value}),B:e.p({content:e.unref(p).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}})})}});c.__runtimeHooks=2,wx.createPage(c);
