"use strict";const e=require("../../../common/vendor.js"),a=require("../../../api/robot.js"),t=require("../../../hooks/useLockFn.js"),o=require("../../../stores/user.js"),u=require("../../../stores/app.js"),r=require("../../../enums/requestEnums.js"),l=require("../../../hooks/useAudioPlay.js"),n=require("../../../hooks/useRecorder.js"),i=require("../../../hooks/useAudio.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../utils/cache.js"),require("../../../enums/constantEnums.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../api/app.js"),require("../../../api/shop.js"),require("../../../lib/fft.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("router-navigate")+e.resolveComponent("chat-record-item")+e.resolveComponent("u-tag")+e.resolveComponent("chat-input")+e.resolveComponent("z-paging")+e.resolveComponent("l-watermark")+e.resolveComponent("l-textarea")+e.resolveComponent("u-button")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../node-modules/uniapp-router-next/components/router-navigate/router-navigate.js")+s+(()=>"../../../components/chat-record-item/chat-record-item.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-tag/u-tag.js")+(()=>"../../../components/chat-input/chat-input.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/lime-watermark/components/l-watermark/l-watermark.js")+c+v+(()=>"../../../components/l-textarea/l-textarea.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js"))();const s=()=>"./components/square-robot.js",c=()=>"../../../components/chat-record-item/quote-popup.js",v=()=>"../../../components/chat-record-item/context-popup.js",d=e.defineComponent({__name:"square_chat",setup(s){const{pauseAll:c}=l.useAudioPlay(),v=u.useAppStore(),d=e.useRouter(),p=e.useRoute(),m=o.useUserStore();e.shallowRef();const h=e.ref(!1),f=e.ref([]),g=e.ref(1),w=e.computed((()=>2===g.value)),y=e.ref(0);e.reactive({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."});const _=e=>{2===g.value&&(y.value=e)},q=e.ref(!1),j=e.ref(0),b=e.ref(!1),k=e.ref(0),x=e.ref(0),C=e.ref(!0),T=e.reactive({id:"audio-canvas",width:100,height:30,minHeight:5,scale:2}),{render:R,stopRender:A,draw:$}=n.useRenderAudioGraph(T),{start:z,stop:P,isRecording:B,authorize:F,close:D}=n.useRecorder({onstart(){b.value=!1,j.value=Date.now()},async onstop(e){if(A(),setTimeout((()=>{$(new Float64Array(new Array(128).fill(0)),0)}),10),q.value){q.value=!1,_(3);try{const t=await a.voiceTransfer(e.tempFilePath);if(!t.text)return void(C.value&&_(2));de(t.text,"voice")}catch(t){C.value&&_(1)}}},ondata(e){R(e);const a=Date.now();e.powerLevel>15&&(clearTimeout(k.value),y.value=2,b.value=!0,j.value=a,k.value=setTimeout((()=>{q.value=!0,clearTimeout(x.value),P()}),2e3)),a-j.value>=5e3&&b.value}}),{play:L,pause:S,isPlaying:E}=i.useAudio({onstart(){y.value=4,N.value&&(N.value=!1,P())},onstop(){var e;x.value=setTimeout((()=>{O()}),1e3*(null==(e=J.value.digital)?void 0:e.idle_time)||0),C.value?_(2):_(1)},onerror(){_(1)}}),V=async e=>{const{url:t}=await a.voiceGenerate(e);return t},M=e.ref(""),N=e.ref(!1),O=async()=>{if(2!==g.value)return Promise.reject();if(!J.value.is_digital||!J.value.digital_id||J.value.is_disable)return Promise.reject();if(M.value||(M.value=await V({type:3,record_id:J.value.id})),!M.value)return Promise.reject();N.value=!0;const a=Date.now();f.value.push({type:2,typing:!1,content:J.value.digital.idle_reply,key:a}),await e.nextTick$1(),le(),L(M.value)};e.watch(g,(async e=>{if(1===e)S(),D(),y.value=0,clearTimeout(x.value);else{C.value=!0,await F(),$(null,0);try{await O()}catch(a){_(2)}le()}})),e.watch(y,(e=>{if(2===e)(async()=>{B.value||2!==g.value||z()})()}));const G=e.reactive({show:!1,data:[]}),I=e.reactive({show:!1,data:[]});e.ref(!1);const J=e.ref({}),U=e.ref(""),H=e.ref(""),K=()=>{if(!m.isLogin)return fe();le()},Q=e.ref(p.query.id),W=e.ref([]),X=e.computed((()=>W.value.find((e=>e.id===Number(Q.value)))||{})),Y=e.computed((()=>X.value.robot_id)),Z=e.shallowRef();let ee=0;const ae=async(e,t)=>{var o,u;try{const{lists:u=[],count:r}=await a.getRobotChatRecord({square_id:X.value.id,robot_id:Y.value,page_size:t/2,page_no:e});if(null==(o=Z.value)||o.complete(u.reverse()),0===r?setTimeout((()=>{var e;null==(e=Z.value)||e.scrollToTop(!1)}),200):1===t&&setTimeout((()=>{le()}),100),2===g.value&&3==y.value){const e=u[0];e&&e.id!==ee&&(ee=e.id,(async e=>{try{const a=await V({type:2,record_id:e});L(a)}catch(a){_(1)}})(ee))}}catch(r){null==(u=Z.value)||u.complete(!1)}},te=e.ref(!1),oe=e=>{e.height>0?te.value=!0:te.value=!1},ue=()=>{te.value=!1},{lockFn:re}=t.useLockFn((async()=>{var t;if(!m.isLogin)return fe();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||(se(),await a.clearRobotChatRecord({robot_id:Y.value,square_id:X.value.id}),null==(t=Z.value)||t.reload())})),le=async()=>{var e;null==(e=Z.value)||e.scrollToBottom(!1)},ne=e.ref(!1);let ie=null;const se=()=>{null==ie||ie.abort(),setTimeout((()=>{U.value=""}))},ce=e.ref({}),{pauseAll:ve}=l.useAudioPlay(),{lockFn:de}=t.useLockFn((async(t,o="text")=>{if(h.value=!1,!m.isLogin)return fe();if(ne.value)return;const u=t||U.value;if(u){Z.value.addChatRecordData({type:1,content:u}),ce.value={type:2,loading:!0,content:[],id:Date.now()},Z.value.addChatRecordData(ce.value),H.value=U.value,U.value="";try{ne.value=!0,_(3),await a.robotChat({cate_id:0,square_id:X.value.id,robot_id:Y.value,question:u,stream:!0},{onstart(e){ie=e,ve(),U.value=""},onmessage(a){a.trim().split("data:").forEach((async a=>{var t,o;if(""!==a)try{const r=JSON.parse(a),{object:l,choices:n,error:i}=r;if(i){const{message:a,code:t}=i;return a&&e.index.$u.toast(a),void f.value.splice(0,2)}const s=null==(o=null==(t=n[0])?void 0:t.delta)?void 0:o.content;switch(l){case"chat":ce.value.content||(ce.value.content=""),ce.value.content+=s;break;case"image":case"video":case"file":{const e=`${l}s`;try{const a=JSON.parse(s);ce.value[e]=a}catch(u){console.error(u)}}}}catch(r){}}))},onclose(){ne.value=!1,setTimeout((()=>{var e;null==(e=Z.value)||e.reload(),m.getUser()}),600)}})}catch(l){console.log("发送消息失败=>",l),l.errMsg!==r.RequestErrMsgEnum.ABORT&&f.value.splice(0,2),"text"==o&&(U.value=H.value),ne.value=!1}}})),pe=e.ref(!1),me=e.reactive({_index:-1,robot_id:-1,record_id:-1,content:""}),he=async()=>{try{await a.chatFeedBack(me),pe.value=!1,me.content="",f.value[me._index].is_feedback=1}catch(e){console.log("反馈提交失败--\x3e",e)}},fe=()=>{d.navigateTo({path:"/pages/login/login"})},ge=async()=>{J.value=await a.getRobotDetail({id:Y.value})};return e.watch(Q,(e=>{g.value=1,ge(),setTimeout((()=>{var a,t;e?null==(a=Z.value)||a.reload():(null==(t=Z.value)||t.complete([]),setTimeout((()=>{var e;null==(e=Z.value)||e.scrollToTop(!1)}),100))}),10)})),e.onShow((async()=>{var e;await(async()=>{W.value=await a.getRobotRecord()})(),ge(),null==(e=Z.value)||e.reload()})),e.onUnmounted((()=>{se()})),(a,t)=>{var o,u;return e.e({a:a.$theme.navColor,b:a.$theme.navBgColor,c:a.$theme.pageStyle,d:J.value.is_digital},J.value.is_digital?{e:e.p({name:"arrow-rightward"}),f:e.o(e.unref(c)),g:e.p({to:{path:"/packages/pages/digital_chat/digital_chat",query:{id:e.unref(Y),squareId:e.unref(X).id}}})}:{},{h:e.o((e=>Q.value=e)),i:e.p({data:W.value,modelValue:Q.value}),j:e.unref(w)},e.unref(w)?{k:!e.unref(E),l:null==(o=J.value.digital)?void 0:o.vertical_stay_video,m:e.unref(E),n:null==(u=J.value.digital)?void 0:u.vertical_talk_video}:{},{o:e.f(f.value,((a,t,o)=>{var u,r,l,n,i,s;return e.e({a:1==a.type},1==a.type?{b:e.unref(w)?1:"",c:"5aaa34aa-5-"+o+",5aaa34aa-4",d:e.p({type:"right",content:a.content,avatar:e.unref(m).userInfo.avatar,showCopyBtn:!0})}:{},{e:2==a.type},2==a.type?e.e({f:!!J.value.is_show_quote&&(null==(u=a.quotes)?void 0:u.length)},J.value.is_show_quote&&(null==(r=a.quotes)?void 0:r.length)?{g:e.t(null==(l=a.quotes)?void 0:l.length),h:e.o((e=>{return t=a.quotes,I.show=!0,void(I.data=t);var t}),`${a.id} + ${t} + ''`)}:{},{i:!!J.value.is_show_context&&(null==(n=a.context)?void 0:n.length)},J.value.is_show_context&&(null==(i=a.context)?void 0:i.length)?{j:e.t(null==(s=a.context)?void 0:s.length),k:e.o((e=>{return t=a.context,G.show=!0,void(G.data=t);var t}),`${a.id} + ${t} + ''`)}:{},{l:a.create_time},a.create_time?{m:e.o((e=>((e,a)=>{1!==f.value[a].is_feedback&&(me.robot_id=Y.value,me.record_id=e.id,me._index=a,pe.value=!0)})(a,t)),`${a.id} + ${t} + ''`),n:"5aaa34aa-7-"+o+",5aaa34aa-6-"+o,o:e.p({text:a.is_feedback?"已反馈":"反馈",type:a.is_feedback?"info":"primary",size:"mini"})}:{},{p:e.unref(w)?1:"",q:"5aaa34aa-6-"+o+",5aaa34aa-4",r:e.p({"record-id":a.id,type:"left",content:a.content,loading:a.loading,avatar:J.value.icons?J.value.icons:J.value.image,index:t,chatType:2,time:a.create_time,showCopyBtn:!0,images:a.images,files:a.files,videos:a.videos,showVoiceBtn:!0,"model-name":a.model})}):{},{s:`${a.id} + ${t} + ''`})})),p:J.value.welcome_introducer},J.value.welcome_introducer?{q:e.unref(w)?1:"",r:e.o(e.unref(de)),s:e.p({type:"left",content:J.value.welcome_introducer,avatar:J.value.icons?J.value.icons:J.value.image,showCopyBtn:!1})}:{},{t:e.f(J.value.menus,((a,t,o)=>({a:e.t(a.keyword),b:t,c:e.o((t=>e.unref(de)(a.keyword)),t)}))),v:e.o(e.unref(de)),w:e.o(se),x:e.o(K),y:e.o(e.unref(re)),z:e.o((e=>U.value=e)),A:e.p({loading:ne.value||3===y.value,"show-stop":ne.value,"safe-area-inset-bottom":!J.value.copyright,modelValue:U.value}),B:e.unref(w)?"":1,C:e.sr(Z,"5aaa34aa-4,5aaa34aa-3",{k:"pagingRef"}),D:e.o(ae),E:e.o(oe),F:e.o(ue),G:e.o((e=>f.value=e)),H:e.p({"use-chat-record-mode":!0,auto:!1,"safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,fixed:!1,modelValue:f.value}),I:e.p({content:e.unref(v).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}}),J:e.unref(w)?J.value.digital_bg:"",K:e.o((e=>I.show=e)),L:e.p({...I,show:I.show}),M:e.o((e=>G.show=e)),N:e.p({...G,show:G.show}),O:e.o((e=>me.content=e)),P:e.p({placeholder:"描述一下你遇到了什么问题",modelValue:me.content}),Q:e.o(he),R:e.p({type:"primary"}),S:e.o((e=>pe.value=e)),T:e.p({"safe-area-inset-bottom":!0,closeable:!0,"border-radius":"16",mode:"center",modelValue:pe.value})})}}});wx.createPage(d);
