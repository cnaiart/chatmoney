"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/robot.js"),o=require("../../../hooks/useLockFn.js"),i=require("../../../stores/user.js"),u=require("../../../enums/requestEnums.js"),r=require("../../../hooks/useAudioPlay.js"),n=require("../../../hooks/useRecorder.js"),l=require("../../../hooks/useAudio.js"),s=require("../../../enums/constantEnums.js"),c=require("../../../utils/cache.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/request/cancel.js"),require("../../../router/index.js"),require("../../../config/index.js"),require("../../../utils/client.js"),require("../../../enums/appEnums.js"),require("../../../api/user.js"),require("../../../utils/auth.js"),require("../../../utils/unique-id.js"),require("../../../lib/fft.js"),!Array){(e.resolveComponent("chat-record-item")+e.resolveComponent("z-paging")+e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("u-input")+e.resolveComponent("dragon-button")+e.resolveComponent("u-empty"))()}Math||((()=>"../../../components/chat-record-item/chat-record-item.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../components/dragon-button/dragon-button.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-empty/u-empty.js")+v)();const v=()=>"./components/login.js",d=e.defineComponent({__name:"share_chat",setup(v){const d=e.useRoute(),p=i.useUserStore();e.shallowRef();const m=e.ref(!1),f=e.ref([]),h=e.ref(!1),g=e.ref(""),{key:y=""}=d.query,w=e.ref({robot:{},digital:{}}),b=e.ref(""),{isLock:j,lockFn:_}=o.useLockFn((async()=>{w.value=await t.getReleaseDetail({apikey:y})})),k=e.computed((()=>{var e;return(null==(e=w.value.menus)?void 0:e.map((e=>({keyword:e}))))||[]})),q=async()=>{const e=c.cache.get(s.AUTHORIZATION_KEY)||{};if(g.value=e[y]||"",w.value.pwd&&!g.value)return h.value=!0,Promise.reject()},x=async e=>{let a=c.cache.get(s.AUTHORIZATION_KEY)||{};g.value=e.password,a=Object.assign(a,{[y]:e.password}),c.cache.set(s.AUTHORIZATION_KEY,a),we()},R=e.ref(0),T=e.reactive({0:"正在初始化对话...",1:"点击开始说话",2:"我在听，您请说...",3:"稍等，让我想一想",4:"正在回复中..."}),C=e.shallowRef();let A=0;const z=async(e,a)=>{var o,i;try{const{lists:i=[],count:u}=await t.getRobotChatRecord({share_apikey:y,identity:p.visitorId,page_size:a/2,page_no:e},{password:g.value,authorization:y,identity:p.visitorId});if(null==(o=C.value)||o.complete(i.reverse()),0===u?setTimeout((()=>{var e;null==(e=C.value)||e.scrollToTop(!1)}),200):1===a&&setTimeout((()=>{E()}),100),3==R.value){const e=i[0];e&&e.id!==A&&(A=e.id,ne(A))}}catch(u){"访问密码错误!"===u&&((()=>{let e=c.cache.get(s.AUTHORIZATION_KEY)||{};e=Object.assign(e,{[y]:""}),c.cache.set(s.AUTHORIZATION_KEY,e)})(),q()),null==(i=C.value)||i.complete(!1)}},{lockFn:I}=o.useLockFn((async()=>{var a;await q();(await e.index.showModal({title:"温馨提示",content:"确定清空对话？"})).cancel||($(),await t.clearRobotChatRecord({},{password:g.value,authorization:y,identity:p.visitorId}),null==(a=C.value)||a.reload())})),E=async()=>{var e;null==(e=C.value)||e.scrollToBottom(!1)},O=e.ref(!1);let F=null;const $=()=>{null==F||F.abort(),setTimeout((()=>{b.value=""}))};e.shallowRef();const D=e=>{R.value=e},P=e.ref({}),L=e.ref(""),{pauseAll:N}=r.useAudioPlay(),{lockFn:U}=o.useLockFn((async(a,o="text")=>{if(m.value=!1,await p.getFingerprint(),await q(),O.value)return;const i=a||b.value;if(i){C.value.addChatRecordData({type:1,content:i}),P.value={type:2,loading:!0,content:[],id:Date.now()},C.value.addChatRecordData(P.value),L.value=b.value,b.value="";try{O.value=!0,D(3),await t.robotChat({question:i,stream:!0},{onstart(e){F=e,N(),b.value=""},onmessage(a){a.trim().split("data:").forEach((async a=>{var t,o;if(""!==a)try{const u=JSON.parse(a),{object:r,choices:n,error:l}=u;if(l){D(1);const{message:a,code:t}=l;return a&&e.index.$u.toast(a),void f.value.splice(0,2)}const s=null==(o=null==(t=n[0])?void 0:t.delta)?void 0:o.content;switch(r){case"chat":P.value.content||(P.value.content=""),P.value.content+=s;break;case"image":case"video":case"file":{const e=`${r}s`;try{const a=JSON.parse(s);P.value[e]=a}catch(i){console.error(i)}}}}catch(u){}}))},onclose(){O.value=!1,setTimeout((()=>{var e;null==(e=C.value)||e.reload()}),600)}},{password:g.value,authorization:y,identity:p.visitorId})}catch(r){console.log("发送消息失败=>",r),r.errMsg!==u.RequestErrMsgEnum.ABORT&&f.value.splice(0,2),"text"==o&&(b.value=L.value),O.value=!1}}})),H=async()=>{await q(),E()},B=e.ref(),K=e.ref(!0),M=e.ref(!1),Y=e.ref(0),Z=e.ref(!1),S=e.ref(0),V=e.reactive({id:"audio-canvas",width:60,height:30,minHeight:4,scale:2}),{render:G,stopRender:J,draw:Q}=n.useRenderAudioGraph(V),{start:W,stop:X,isRecording:ee,authorize:ae,close:te,isOpen:oe}=n.useRecorder({onstart(){D(2),clearTimeout(B.value),ue(),Z.value=!1,Y.value=Date.now()},async onstop(e){if(J(),Z.value=!1,M.value){M.value=!1,D(3);try{const a=await t.voiceTransfer(e.tempFilePath);if(!a.text)return void(K.value?le():D(1));U(a.text,"voice")}catch(a){D(1)}}else D(1)},ondata(e){var a;const t=Date.now();Z.value&&G(e),e.powerLevel>=10&&(clearTimeout(S.value),R.value=2,Z.value=!0,Y.value=t,S.value=setTimeout((()=>{M.value=!0,clearTimeout(B.value),ue(),X()}),2e3)),t-Y.value>=1e3*(null==(a=w.value.digital)?void 0:a.idle_time)&&(Z.value||(pe(),X()))}}),{play:ie,pause:ue,isPlaying:re}=l.useAudio({onstart(){R.value=4,de.value&&(de.value=!1)},onstop(){D(2),K.value?le():D(1)},onerror(){D(1)}}),ne=async e=>{const a=await ce({type:2,record_id:e});ie(a)},le=async()=>{ee.value||(await ae(),W())},se=async()=>{4!=R.value?3!=R.value&&(ee.value?(K.value=!1,X(),D(1)):(K.value=!0,le())):ue()},ce=async e=>{try{const{url:a}=await t.voiceGenerate(e,{password:g.value,authorization:y,identity:p.visitorId});return a}catch(a){return D(1),Promise.reject()}},ve=e.ref(""),de=e.ref(!1),pe=async()=>{if(!w.value.is_digital||!w.value.digital_id)return Promise.reject();if(ve.value||(ve.value=await ce({type:3,record_id:w.value.id})),!ve.value)return Promise.reject();de.value=!0;const a=Date.now();C.value.addChatRecordData({type:2,typing:!1,content:w.value.digital.idle_reply,key:a}),await e.nextTick$1(),E(),ie(ve.value)};let me=null,fe=null,he=!1,ge=!1;const ye=async()=>{ge=!0,he&&(await ae(),le())},we=async()=>{var a;await q(),null==(a=C.value)||a.reload(),K.value=!0,me=e.index.createVideoContext("stay-video"),fe=e.index.createVideoContext("talk-video");const{confirm:t}=await e.index.showModal({title:"温馨提示",showCancel:!1,content:"形象内容由AI生成，请合法使用形象"});t&&(null==me||me.play(),null==fe||fe.play(),he=!0),ge&&(await ae(),le())};return e.onLoad((async()=>{await _(),await p.getFingerprint(),we()})),e.onUnmounted((()=>{$(),ue(),X()})),(t,o)=>{var i,u;return e.e({a:t.$theme.navColor,b:t.$theme.navBgColor,c:t.$theme.pageStyle,d:0==R.value},0==R.value?{e:a._imports_0}:{},{f:w.value.digital.id||e.unref(j)},w.value.digital.id||e.unref(j)?e.e({g:4!==R.value,h:null==(i=w.value.digital)?void 0:i.vertical_stay_video,i:e.o(ye),j:4===R.value,k:null==(u=w.value.digital)?void 0:u.vertical_talk_video,l:e.t(w.value.name),m:e.f(f.value,((o,i,u)=>e.e({a:1==o.type},1==o.type?{b:"e1103eb8-1-"+u+",e1103eb8-0",c:e.p({type:"left",content:o.content,avatar:e.unref(a.DefaultAvatar),showCopyBtn:!1,bg:t.$theme.primaryColor,color:"#fff"})}:{},{d:2==o.type},2==o.type?{e:"e1103eb8-2-"+u+",e1103eb8-0",f:e.p({"record-id":o.id,type:"left",bg:"rgba(0, 0, 0, 0.5)",color:"#fff",content:o.content,loading:o.loading,avatar:w.value.robot.icons?w.value.robot.icons:w.value.robot.image,index:i,chatType:2,showCopyBtn:!1,images:o.images,files:o.files,videos:o.videos})}:{},{g:`${o.id} + ${i} + ''`}))),n:e.sr(C,"e1103eb8-0",{k:"pagingRef"}),o:e.o(z),p:e.o((e=>f.value=e)),q:e.p({"use-chat-record-mode":!0,auto:!1,height:"500rpx",width:"600rpx","safe-area-inset-bottom":!0,"auto-clean-list-when-reload":!1,"show-chat-loading-when-reload":!0,"default-page-size":20,fixed:!1,modelValue:f.value}),r:O.value},O.value?{s:e.p({name:"pause-circle",size:30}),t:e.o($),v:e.p({color:"#fff",shape:"circle",size:"medium"})}:{},{w:e.t(T[R.value]),x:e.f(e.unref(k),((a,t,o)=>({a:e.t(a.keyword),b:t,c:e.o((t=>e.unref(U)(a.keyword)),t)}))),y:e.o(H),z:e.o((e=>b.value=e)),A:e.p({placeholder:"请输入内容",maxlength:"-1","auto-height":!0,"confirm-type":"send","adjust-position":!0,fixed:!1,"adjust-keyboard-to":"bottom",modelValue:b.value}),B:a._imports_1$1,C:e.o((a=>e.unref(U)(b.value))),D:e.p({type:"primary","custom-style":{width:"100rpx",height:"66rpx",margin:"0",borderRadius:"100px",background:"linear-gradient(90deg, #54C6EE 0%, #3C5EFD 100%)!important"},size:"mini",disabled:[3,4].includes(R.value)}),E:a._imports_2,F:e.o(((...a)=>e.unref(I)&&e.unref(I)(...a))),G:Z.value},Z.value?{H:`${V.width}px`,I:`${V.height}px`,J:V.width*V.scale,K:V.height*V.scale,L:V.id}:{},{M:e.unref(ee)&&!Z.value},e.unref(ee)&&!Z.value?{N:e.p({name:"mic",size:48})}:e.unref(re)?{P:e.p({name:"pause-circle",size:60})}:e.unref(ee)?{}:{R:e.p({name:"mic-off",size:48})},{O:e.unref(re),Q:!e.unref(ee),S:e.unref(ee)||e.unref(re)?"":1,T:e.o(se),U:e.p({size:120,xEdge:"10",yEdge:"100"}),V:w.value.robot.digital_bg}):{W:e.p({text:"该智能体暂未配置形象",mode:"page"})},{X:e.o(x),Y:e.o((e=>h.value=e)),Z:e.p({show:h.value})})}}}),p=e._export_sfc(d,[["__scopeId","data-v-e1103eb8"]]);wx.createPage(p);
