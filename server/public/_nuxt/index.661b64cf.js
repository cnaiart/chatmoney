import{a5 as tt,a as ot,m as at,h as st,a6 as Re,a7 as nt,j as D,d as rt}from"./entry.dfbfd4fd.js";import{_ as it}from"./nuxt-link.42058260.js";import{_ as lt}from"./index.vue.74e23ebc.js";import{_ as ct,a as dt,b as ut}from"./index.ff59938d.js";import{_ as pt}from"./index.vue.7f39d825.js";import{E as ft}from"./index.2e91aacc.js";import{_ as _t}from"./index.a47f7f49.js";import{k as mt,a as v,s as J,r as le,aa as ce,b as Z,l as vt,E as ht,n as de,j as yt,H as p,I as q,J as n,u as e,Z as N,U as S,V as c,X as h,a7 as P,R as C,_ as Se,T as G,S as Ce,aj as Te,Y as gt,$ as W,a0 as Y}from"./swiper-vue.2eb6bd20.js";import{u as wt}from"./useCopy.5611cfa5.js";import{u as ue}from"./asyncData.eaddccf2.js";import{u as bt,a as xt}from"./useRecorder.ad274156.js";import{u as kt}from"./useAudioPlay.fe45c428.js";import{g as It,c as Rt,a as St,b as Ct,r as Tt,v as Et,d as qt}from"./robot.b9f1d754.js";import{u as Lt}from"./robot.ea6c8ba0.js";import{P as $t}from"./index.e94bc8a7.js";import{E as zt}from"./index.17567b0d.js";import{_ as At}from"./_plugin-vue_export-helper.c27b6911.js";const Vt={class:"h-full flex flex-col"},Dt={class:"flex items-center p-4 px-[40px] border-b border-solid border-br-light"},Nt=["src"],Pt={class:"ml-[15px]"},jt={class:"flex items-center"},Bt={class:"text-2xl line-clamp-1"},Mt={class:"text-tx-secondary mt-[4px] line-clamp-2"},Ft={class:"absolute top-0 left-0 w-full h-full flex flex-col z-10"},Ot={class:"flex-1 min-h-0"},Ut={class:"py-4 px-8"},Ht={class:"my-[5px]"},Jt={key:1,class:"flex flex-col",style:{"margin-left":"52px"}},Zt=["onClick"],Gt={class:"mr-2 text-tx-primary"},Wt={class:"flex flex-col justify-center items-center"},Yt=["width","height","id"],Kt={class:"text-xs text-white"},Qt={class:"px-[30px]"},Xt={class:"absolute top-0 left-0 w-full h-full flex justify-center items-center"},eo=["src"],to=["src"],oo={class:"flex justify-center mt-4"},ao=mt({__name:"index",props:{robotId:{},squareId:{}},async setup(Ee){let w,L;const d=Ee,pe=tt(),$=ot(),b=at(),u=Lt(),y=v(1),{copy:qe}=wt(),K=J(),T=le({_index:-1,robot_id:d.robotId,record_id:-1,content:""}),Le=(t,o)=>{var _;T.record_id=t.id,T._index=o,(_=K.value)==null||_.open()},$e=async()=>{var t;try{await Rt(T),(t=K.value)==null||t.close(),T.content="",f.value[T._index].is_feedback=1}catch(o){console.log("反馈提交失败-->",o)}},fe=async()=>{if(!d.squareId)await u.getSessionLists(),u.setSessionSelect();else return[]};[w,L]=ce(()=>ue(()=>fe(),{lazy:!0},"$kMIVzocZNF")),await w,L();const f=v([]),ze=st();let Q=0;const V=async()=>{if(!u.sessionId&&!d.squareId)return[];const t=await St({square_id:d.squareId,category_id:u.sessionId,robot_id:d.robotId,page_size:25e3});if(f.value=t.lists||[],y.value===2&&k.value==3){const o=f.value[f.value.length-1];o&&o.id!==Q&&(Q=o.id,Ze(Q))}};[w,L]=ce(()=>ue(()=>V(),{lazy:!0},"$RvfqdxlKCY")),await w,L();const{data:a,refresh:Ae}=([w,L]=ce(()=>ue(()=>It({id:d.robotId}),{default(){return{}},lazy:!0},"$atbZEM2Qb5")),w=await w,L(),w);Z(()=>d.robotId,()=>{Ae()});const Ve=async()=>{if(!b.isLogin)return b.toggleShowLogin();!u.sessionId&&!d.squareId||(await D.confirm("确定清空记录？"),await Ct({square_id:d.squareId,category_id:u.sessionId,robot_id:d.robotId}),V())},j=J(),De=()=>{var t;if(!b.isLogin)return(t=j.value)==null||t.blur(),b.toggleShowLogin();E()};let r=null;const x=v(!1);let X=!1;const ee=v([]),B=async(t,o="input")=>{var O;if(!b.isLogin)return b.toggleShowLogin();if(!t)return D.msgError("请输入问题");if(x.value||!d.robotId)return;g(3);const _=Date.now();x.value=!0,f.value.push({type:1,content:t}),f.value.push({type:2,typing:!0,content:"",key:_}),(O=j.value)==null||O.setInputValue();const m=f.value.find(i=>i.key===_);d.squareId||(u.sessionId||(X=!0,await u.sessionAdd(),X=!1),u.getCurrentSession.name==="新的会话"&&await u.sessionEdit({id:u.sessionId,name:t})),r=Tt({square_id:d.squareId,cate_id:u.sessionId,robot_id:d.robotId,question:t,stream:!0}),r.addEventListener("chat",({data:i})=>{const{data:l,index:R}=i;m.content||(m.content=""),m.content+=l}),r.addEventListener("question",({data:i})=>{ee.value=JSON.parse(i.data)}),r.addEventListener("file",({data:i})=>{try{const l=JSON.parse(i.data);m.files=l}catch(l){console.error(l)}}),r.addEventListener("image",({data:i})=>{try{const l=JSON.parse(i.data);m.images=l}catch(l){console.error(l)}}),r.addEventListener("video",({data:i})=>{try{const l=JSON.parse(i.data);m.videos=l}catch(l){console.error(l)}}),r.addEventListener("close",async()=>{await b.getUser(),setTimeout(async()=>{await V(),m.typing=!1,x.value=!1,await de(),E()},500)}),r.addEventListener("error",async i=>{var l,R;if(z.value&&g(2),o==="input"&&((l=j.value)==null||l.setInputValue(t)),((R=i.data)==null?void 0:R.code)===1100){$.getIsShowRecharge?(await D.confirm(`${$.getTokenUnit}数量已用完，请前往充值`),ze.push("/user/recharge")):D.msgError(`${$.getTokenUnit}数量已用完。请联系客服增加`);return}i.errorType==="connectError"&&D.msgError("请求失败，请重试"),["connectError","responseError"].includes(i.errorType)&&f.value.splice(f.value.length-2,2),m.typing=!1,setTimeout(()=>{x.value=!1},200)})},te=J(),_e=v(),E=async()=>{var o,_,m;const t=(_=(o=te.value)==null?void 0:o.wrapRef)==null?void 0:_.scrollHeight;(m=te.value)==null||m.setScrollTop(t)},{height:Ne}=Re(_e);nt(Ne,()=>{x.value&&E()},{throttle:500,immediate:!0});const me=J(),{height:Pe,width:je}=Re(me),ve=vt(()=>!(je.value/Pe.value>1)),oe=()=>{r==null||r.removeEventListener("close"),r==null||r.removeEventListener("chat"),r==null||r.removeEventListener("error"),r==null||r.abort(),x.value=!1};Z(()=>u.sessionId,async t=>{t&&!X&&(oe(),await V(),E())},{immediate:!0});const k=v(0),Be=le({[0]:"正在初始化对话...",[1]:"点击开始说话",[2]:"我在听，您请说...",[3]:"稍等，让我想一想",[4]:"正在回复中..."}),g=t=>{y.value===2&&(k.value=t)},ae=v(!1),se=v(0),ne=v(!1),he=v(0),ye=v(0),I=le({id:"audio-canvas",width:100,height:40,minHeight:5,scale:2}),{render:Me,stopRender:Fe,draw:Oe}=bt(I),{start:Ue,stop:re,isRecording:M,authorize:so,close:no,isOpen:ro}=xt({onstart(){ne.value=!1,se.value=Date.now()},async onstop(t){if(Fe(),Oe(new Float64Array(new Array(128).fill(0)),0),!!ae.value){ae.value=!1,g(3);try{const o=await Et({file:t.blob});if(!o.text){z.value&&g(2);return}B(o.text,"voice")}catch{z.value&&g(2)}}},ondata(t){Me(t);const o=Date.now();t.powerLevel>15&&(clearTimeout(he.value),k.value=2,ne.value=!0,se.value=o,he.value=setTimeout(()=>{ae.value=!0,clearTimeout(ye.value),Je(),re()},2e3)),o-se.value>=5e3&&ne.value}}),He=()=>{var t;ye.value=setTimeout(()=>{Ye()},((t=a.value.digital)==null?void 0:t.idle_time)*1e3||0)},{play:ge,pause:Je,audioPlaying:we}=kt({onstart(){k.value=4,ie.value&&(ie.value=!1,re())},onstop(){He(),z.value?g(2):g(1)},onerror(){g(1)}}),be=async t=>{const{url:o}=await qt(t);return o},Ze=async t=>{ge(async()=>await be({type:2,record_id:t}),!1)},Ge=async()=>{M.value||y.value!==2||Ue()},z=v(!0),We=async()=>{[4,3].includes(k.value)||(M.value?(z.value=!1,re(),g(1)):(z.value=!0,g(2)))},F=v(""),ie=v(!1),Ye=async()=>{if(y.value!==2||!a.value.is_digital||!a.value.digital_id||a.value.is_disable||(F.value||(F.value=await be({type:3,record_id:a.value.id})),!F.value))return Promise.reject();ie.value=!0;const t=Date.now();f.value.push({type:2,typing:!1,content:a.value.digital.idle_reply,key:t}),await de(),E(),ge(F.value,!1)};return Z(k,t=>{switch(t){case 2:Ge()}}),Z(()=>d.robotId,async t=>{oe(),u.setRobotId(t),await V(),E(),await fe()},{immediate:!0}),ht(async()=>{await de(),f.value.length&&E()}),yt(()=>{oe()}),(t,o)=>{const _=rt,m=it,O=lt,i=ct,l=dt,R=pt,Ke=ut,Qe=ft,Xe=_t;return p(),q("div",Vt,[n("div",Dt,[n("img",{class:"flex-none w-[40px] h-[40px] rounded-full",src:e(a).image,alt:""},null,8,Nt),n("div",Pt,[n("div",jt,[n("div",Bt,N(e(a).name),1),t.squareId?C("",!0):(p(),S(m,{key:0,to:"/application/layout/robot",class:"ml-[10px]"},{default:c(()=>[h(_,{type:"info",round:"",text:"",bg:"",style:{border:"none","--el-button-hover-text-color":`var(
                                    --el-color-info
                                )`}},{default:c(()=>[P(" 切换智能体 ")]),_:1})]),_:1}))]),n("div",Mt,N(e(a).intro),1)])]),h(Qe,{class:"flex-1 min-h-0",content:e($).getChatConfig.watermark,font:{color:e(pe)?"rgba(256,256,256,0.08)":"rgba(0,0,0,0.06)",fontSize:12}},{default:c(()=>{var U,xe,ke,Ie;return[n("div",{ref_key:"containerRef",ref:me,class:"h-full flex flex-col rounded relative",style:Se({background:e(y)==2?e(a).digital_bg:""})},[n("div",Ft,[n("div",Ot,[h(e(zt),{ref_key:"scrollbarRef",ref:te},{default:c(()=>[n("div",Ut,[n("div",{ref_key:"innerRef",ref:_e},[e(a).welcome_introducer?(p(),S(i,{key:0,class:G(["mb-[20px]",{"opacity-70":e(y)===2}]),type:"left",bg:"var(--el-bg-color-page)",avatar:e(a).icons?e(a).icons:e(a).image},{default:c(()=>[h(O,{content:e(a).welcome_introducer,onClickCustomLink:o[0]||(o[0]=s=>B(s,"link"))},null,8,["content"])]),_:1},8,["avatar","class"])):C("",!0),(p(!0),q(Ce,null,Te(e(f),(s,A)=>(p(),q("div",{key:s.id+""+A,class:"mt-4 sm:pb-[20px]"},[s.type==1?(p(),S(i,{key:0,type:"right",avatar:e(b).userInfo.avatar,color:"white",class:G({"opacity-70":e(y)===2})},{actions:c(()=>[n("div",Ht,[h(_,{link:"",type:"info",onClick:H=>e(qe)(s.content)},{icon:c(()=>[h(R,{name:"el-icon-CopyDocument"})]),default:c(()=>[P(" 复制 ")]),_:2},1032,["onClick"])])]),default:c(()=>[h(l,{content:String(s.content)},null,8,["content"])]),_:2},1032,["avatar","class"])):C("",!0),s.type==2?(p(),S(i,{key:1,type:"left",time:s.create_time,avatar:e(a).icons?e(a).icons:e(a).image,bg:"var(--el-bg-color-page)",class:G({"opacity-70":e(y)===2}),modelName:s.model},{outer_actions:c(()=>[s.create_time?(p(),S(_,{key:0,class:"ml-[52px] mt-2",style:{"--el-button-border-color":"transparent","--el-color-info-light-8":"transparent"},type:s.is_feedback?"info":"primary",plain:!0,bg:"",size:"small",disabled:s.is_feedback,onClick:H=>Le(s,A)},{default:c(()=>[P(N(s.is_feedback?"已反馈":"反馈"),1)]),_:2},1032,["type","disabled","onClick"])):C("",!0),A===e(f).length-1&&!e(x)?(p(),q("div",Jt,[(p(!0),q(Ce,null,Te(e(ee).length?e(ee):s.correlation,(H,et)=>(p(),q("div",{key:et,class:"inline-flex items-center rounded-[12px] bg-page cursor-pointer mt-[10px] hover:bg-primary-light-9",style:{padding:"8px 12px",width:"fit-content"},onClick:gt(io=>B(H,"input"),["stop"])},[n("span",Gt,N(H),1),h(R,{name:"el-icon-Right",color:"#999",size:"20"})],8,Zt))),128))])):C("",!0)]),default:c(()=>[h(l,{content:String(s.content),type:"html",typing:s.typing,"line-numbers":!e($).isMobile,"show-copy":"","show-context":!!e(a).is_show_context,"show-quote":!!e(a).is_show_quote,"show-voice":e($).getIsVoiceOpen,context:s.context,"show-poster":"","record-list":e(f),quotes:s.quotes,images:s.images,files:s.files,videos:s.videos,"record-id":s.id,"record-type":2},null,8,["content","typing","line-numbers","show-context","show-quote","show-voice","context","record-list","quotes","images","files","videos","record-id"])]),_:2},1032,["time","avatar","class","modelName"])):C("",!0)]))),128))],512)])]),_:1},512)]),W(n("div",Wt,[n("canvas",{style:Se({width:`${e(I).width}px`,height:`${e(I).height}px`}),width:e(I).width*e(I).scale,height:e(I).height*e(I).scale,id:e(I).id},null,12,Yt),n("div",Kt,[n("div",null,N(e(Be)[e(k)]),1)])],512),[[Y,e(y)==2]]),n("div",Qt,[h(Ke,{ref_key:"chatActionRef",ref:j,loading:e(x)||e(k)===3,"show-manual":!!e(a).is_artificial,"btn-color":e(pe)?"#333":"#f6f6f6",onEnter:B,onClear:Ve,onPause:o[1]||(o[1]=s=>{var A;return(A=e(r))==null?void 0:A.abort()}),onFocus:De,menus:e(a).menus},{btn:c(()=>[e(a).is_digital?(p(),S(m,{key:0,target:"_blank",to:{path:"/digital/chat",query:{id:t.robotId,squareId:t.squareId,cateId:e(u).sessionId}},class:"flex items-center mr-[10px]"},{default:c(()=>[h(_,{type:"primary",round:"",plain:""},{default:c(()=>[P(" 形象对话")]),_:1})]),_:1},8,["to"])):C("",!0)]),_:1},8,["loading","show-manual","btn-color","menus"])]),e(y)==2?(p(),q("div",{key:0,class:G(["recorder",{"recorder--stop":!e(M)}]),onClick:We},[e(M)?(p(),S(R,{key:0,name:"el-icon-Microphone",size:40})):(p(),S(R,{key:1,name:"el-icon-Mute",size:40}))],2)):C("",!0)]),W(n("div",Xt,[W(n("video",{class:"h-full w-full object-scale-down",src:e(ve)?(U=e(a).digital)==null?void 0:U.vertical_stay_video:(xe=e(a).digital)==null?void 0:xe.wide_stay_video,autoplay:"",muted:"",loop:""},null,8,eo),[[Y,!e(we)]]),W(n("video",{class:"h-full w-full object-scale-down",src:e(ve)?(ke=e(a).digital)==null?void 0:ke.vertical_talk_video:(Ie=e(a).digital)==null?void 0:Ie.wide_talk_video,autoplay:"",muted:"",loop:""},null,8,to),[[Y,e(we)]])],512),[[Y,e(y)==2]])],4)]}),_:1},8,["content","font"]),h($t,{ref_key:"popupRef",ref:K,async:!0,title:"问题反馈",appendToBody:!1,class:"feedback-pop"},{footer:c(()=>[n("div",oo,[h(_,{type:"primary",onClick:$e},{default:c(()=>[P(" 提交反馈 ")]),_:1})])]),default:c(()=>[h(Xe,{modelValue:e(T).content,"onUpdate:modelValue":o[2]||(o[2]=U=>e(T).content=U),rows:"8",placeholder:"描述一下你遇到了什么问题"},null,8,["modelValue"])]),_:1},512)])}}});const So=At(ao,[["__scopeId","data-v-9289f797"]]);export{So as _};
