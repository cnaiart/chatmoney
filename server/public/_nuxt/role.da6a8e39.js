import{a as ge,_ as he,b as ve}from"./index.ff59938d.js";import{_ as ye}from"./index.vue.7f39d825.js";import{a5 as we,e as be,h as xe,a as ke,m as Ce,a6 as Le,a7 as Ee,cE as Re,j as N,_ as Se,d as Te}from"./entry.dfbfd4fd.js";import{_ as Ue}from"./index.5054c8b8.js";import{E as $e}from"./index.2e91aacc.js";import{u as Ne}from"./useCopy.5611cfa5.js";import{k as De,s as ee,a as k,aa as P,r as Me,E as Ae,j as Ve,H as u,I as v,X as p,V as d,J as _,u as e,e as te,R as D,S as J,aj as O,n as oe,U as Y,a7 as ze,Y as Be,Z as Fe,T as Ie}from"./swiper-vue.2eb6bd20.js";import{u as Z}from"./asyncData.eaddccf2.js";import{u as qe}from"./useLockFn.619a13da.js";import{e as je,b as ne,c as He}from"./chat.01f4dab8.js";import Pe from"./role-sidebar.ddd30c6e.js";import{E as Je}from"./index.17567b0d.js";import{_ as Oe}from"./_plugin-vue_export-helper.c27b6911.js";import"./index.e979a1ab.js";/* empty css               */import"./index.vue.74e23ebc.js";import"./index.edaf9b5e.js";import"./el-image-viewer.d5621b18.js";import"./throttle.d40f833a.js";import"./debounce.8cbe4cfc.js";import"./position.4bcf7430.js";import"./file.598d0601.js";import"./index.f647f618.js";import"./___vite-browser-external.5512611b.js";import"./index.9c8f8f3a.js";import"./index.6c069afb.js";import"./use-dialog.7d399731.js";import"./isUndefined.aa0326a0.js";import"./refs.cabac943.js";/* empty css                  */import"./el-link.5fd49d40.js";import"./useAudioPlay.fe45c428.js";/* empty css                     */import"./knowledge.51dee290.js";import"./download.f61d7233.js";import"./qrcode.vue.esm.415e365a.js";import"./isString.78966428.js";import"./el-upload.5844c619.js";import"./el-progress.8f5e9f30.js";import"./cloneDeep.4e82bacf.js";import"./_baseClone.20563df6.js";import"./_getTag.83294aff.js";import"./isEqual.0df0ab2c.js";import"./el-select.b7a2650e.js";import"./index.8ad94f19.js";import"./strings.ceb81673.js";import"./_baseIteratee.5e0c38c1.js";import"./index.071e9281.js";import"./castArray.c741e965.js";import"./el-collapse.1527f898.js";import"./index.93ec1a3c.js";/* empty css                  */import"./index.e94bc8a7.js";import"./useQuery.ba65a97e.js";import"./nuxt-link.42058260.js";function Ye(M){return $request.get({url:"/chat.skill/lists",params:M})}function Ze(M){return $request.get({url:"/chat.skill/detail",params:M})}const Ge={class:"h-full flex"},We={class:"p-[16px]"},Xe={class:"flex-1 min-w-0 pr-4 py-4"},Ke={class:"h-full flex flex-col bg-body rounded-[12px]"},Qe={class:"flex-1 min-h-0"},et={key:0,class:"px-[40px] pt-[40px]"},tt={class:"my-[5px]"},ot={key:0,class:"flex flex-col",style:{"margin-left":"52px"}},nt=["onClick"],rt={class:"mr-2 text-tx-primary"},at={class:"mb-[10px] px-[30px]"},st={class:"mr-[10px]"},it=De({__name:"role",async setup(M){let c,C;const re=we(),{copy:ae}=Ne(),se=be(),G=xe(),x=ke(),y=Ce(),A=ee(),I=ee(),W=k(),V=k(""),L=k(""),w=k(Number(se.query.id)),{data:z,refresh:X}=([c,C]=P(()=>Z(()=>Ye({keyword:L.value}),{default(){return[]},lazy:!0,immediate:!1},"$sJo73HUy0r")),c=await c,C(),c),{data:E,refresh:K}=([c,C]=P(()=>Z(()=>Ze({id:w.value}),{lazy:!0,immediate:!1},"$FeZRwM0ASG")),c=await c,C(),c),{data:a,refresh:q}=([c,C]=P(()=>Z(()=>je({type:3,other_id:w.value,page_type:0}),{transform(t){return t.lists||[]},default(){return[]},lazy:!0},"$xhlnmU1xdY")),c=await c,C(),c),g=Me({show:!1,data:{url:"",name:"",type:"image"}}),ie=t=>{g.show=!!t.support_image,g.show||(g.data.url="")},j=({id:t,image:o})=>{G.push({path:"/dialogue/role",query:{id:t}}),w.value=Number(t),oe(async()=>{await q(),E.value={image:o},await K(),F()})},le=async()=>{if(!y.isLogin)return y.toggleShowLogin();await N.confirm("确定清空记录？"),await ne({other_id:w.value,type:3}),q()},B=k(-1),{lockFn:ce}=qe(async()=>{const t=a.value[a.value.length-1],o=a.value.find(({id:i})=>i===t.id);o&&(B.value=t.id,a.value.splice(a.value.length-2,2),R(o.content))}),ue=()=>{var t;if(!y.isLogin)return(t=A.value)==null||t.blur(),y.toggleShowLogin();F()};let n=null;const b=k(!1),H=k([]),R=async(t,o="input")=>{var S;if(!y.isLogin)return y.toggleShowLogin();if(!t)return N.msgError("请输入问题");if(b.value)return;const i=Date.now();b.value=!0,a.value.push({type:1,content:t,files_plugin:[{...g.data}]}),a.value.push({type:2,typing:!0,content:[""],key:i}),(S=A.value)==null||S.setInputValue();const s=a.value.find(l=>l.key===i);n=He({type:3,other_id:w.value,question:t,model:V.value,file:g.data.url}),n.addEventListener("chat",({data:l})=>{const{data:h,index:m}=l;s.content[m]||(s.content[m]=""),s.content[m]+=h}),n.addEventListener("question",({data:l})=>{H.value=JSON.parse(l.data)}),n.addEventListener("finish",({data:l})=>{const{data:h,index:m}=l;h&&(s.content[m]+=h),g.data.url=""}),n.addEventListener("close",async()=>{B.value!==-1&&s.content[0].length&&(await ne({type:1,id:B.value}),B.value=-1),await y.getUser(),setTimeout(async()=>{await q(),b.value=!1,s.typing=!1,await oe(),F()},600)}),n.addEventListener("error",async l=>{var h,m;if(o==="input"&&((h=A.value)==null||h.setInputValue(t)),((m=l.data)==null?void 0:m.code)===1100){x.getIsShowRecharge?(await N.confirm(`${x.getTokenUnit}数量已用完，请前往充值`),G.push("/user/recharge")):N.msgError(`${x.getTokenUnit}数量已用完。请联系客服增加`);return}l.errorType==="connectError"&&N.msgError("请求失败，请重试"),["connectError","responseError"].includes(l.errorType)&&a.value.splice(a.value.length-2,2),s.typing=!1,setTimeout(()=>{b.value=!1},200)})},F=async()=>{var o,i,s;const t=(i=(o=I.value)==null?void 0:o.wrapRef)==null?void 0:i.scrollHeight;(s=I.value)==null||s.setScrollTop(t)},{height:pe}=Le(W);Ee(pe,()=>{b.value&&F()},{immediate:!0});const de=()=>{n==null||n.removeEventListener("chat"),n==null||n.removeEventListener("close"),n==null||n.removeEventListener("error"),n==null||n.removeEventListener("finish"),n==null||n.abort(),b.value=!1},me=()=>{if(!w.value)j(z.value[0].skill[0]);else for(let t=0;t<z.value.length;t++){const o=z.value[t];for(let i=0;i<o.skill.length;i++){const s=o.skill[i];if(s.id===w.value){j(s);return}}}};return Re(L,t=>{X()},{debounce:500}),Ae(async()=>{await X(),me(),await K()}),Ve(()=>{de()}),(t,o)=>{const i=ge,s=he,S=ye,l=Te,h=Ue,m=ve,fe=$e,_e=Se;return u(),v("div",null,[p(_e,{name:"default"},{default:d(()=>[_("div",Ge,[_("div",We,[p(Pe,{keyword:e(L),"onUpdate:keyword":o[0]||(o[0]=f=>te(L)?L.value=f:null),sidebarList:e(z),currentId:e(w),onOntoggle:j},null,8,["keyword","sidebarList","currentId"])]),_("div",Xe,[p(fe,{class:"h-full",content:e(x).getChatConfig.watermark,font:{color:e(re)?"rgba(256,256,256,0.08)":"rgba(0,0,0,0.06)",fontSize:12}},{default:d(()=>[_("div",Ke,[_("div",Qe,[p(e(Je),{ref_key:"scrollbarRef",ref:I},{default:d(()=>{var f;return[_("div",null,[!e(a).length&&((f=e(E))!=null&&f.tips)?(u(),v("div",et,[p(s,{type:"left",avatar:e(E).image,bg:"var(--el-bg-color-page)"},{default:d(()=>{var r;return[p(i,{content:(r=e(E))==null?void 0:r.tips,type:"html",typing:!1,"line-numbers":!e(x).isMobile,"show-collect-btn":!1,"show-copy-btn":!1,"show-poster":!1,"show-voice":!1,class:"mb-[15px] last-of-type:mb-0",onClickCustomLink:o[1]||(o[1]=T=>R(T,"link"))},null,8,["content","line-numbers"])]}),_:1},8,["avatar"])])):D("",!0),e(a).length?(u(),v("div",{key:1,ref_key:"innerRef",ref:W,class:"px-8"},[(u(!0),v(J,null,O(e(a),(r,T)=>{var Q;return u(),v("div",{key:r.id+""+T,class:"mt-4 sm:pb-[20px]"},[r.type==1?(u(),Y(s,{key:0,type:"right",avatar:e(y).userInfo.avatar,color:"white"},{actions:d(()=>[_("div",tt,[p(l,{link:"",type:"info",onClick:U=>e(ae)(r.content)},{icon:d(()=>[p(S,{name:"el-icon-CopyDocument"})]),default:d(()=>[ze(" 复制 ")]),_:2},1032,["onClick"])])]),default:d(()=>[p(i,{content:r.content,"files-plugin":r.files_plugin},null,8,["content","files-plugin"])]),_:2},1032,["avatar"])):D("",!0),r.type==2?(u(),Y(s,{key:1,type:"left",avatar:(Q=e(E))==null?void 0:Q.image,time:r.create_time,bg:"var(--el-bg-color-page)",modelName:r.model},{outer_actions:d(()=>[T===e(a).length-1&&!e(b)?(u(),v("div",ot,[(u(!0),v(J,null,O(e(H).length?e(H):r.correlation,(U,$)=>(u(),v("div",{key:$,class:"inline-flex items-center rounded-[12px] bg-page cursor-pointer mt-[10px] hover:bg-primary-light-9",style:{padding:"8px 12px",width:"fit-content"},onClick:Be(lt=>R(U,"input"),["stop"])},[_("span",rt,Fe(U),1),p(S,{name:"el-icon-Right",color:"#999",size:"20"})],8,nt))),128))])):D("",!0)]),default:d(()=>[(u(!0),v(J,null,O(r.content,(U,$)=>(u(),Y(i,{key:$,content:U,type:"html",typing:r.typing,"line-numbers":!e(x).isMobile,"show-rewrite":T===e(a).length-1,"show-copy":"","show-voice":e(x).getIsVoiceOpen,class:Ie(["mb-[15px] last-of-type:mb-0",{"pt-[15px] border-t border-solid border-br-light":$>0}]),index:$,"record-id":r.id,"show-poster":"","record-list":e(a),onRewrite:e(ce)},null,8,["content","typing","line-numbers","show-rewrite","show-voice","class","index","record-id","record-list","onRewrite"]))),128))]),_:2},1032,["avatar","time","modelName"])):D("",!0)])}),128))],512)):D("",!0)])]}),_:1},512)]),_("div",at,[p(m,{ref_key:"chatActionRef",ref:A,loading:e(b),"show-continue":e(a).length,"show-file-upload":e(g).show,"file-plugin":e(g).data,"onUpdate:filePlugin":o[3]||(o[3]=f=>e(g).data=f),onEnter:R,onClear:le,onPause:o[4]||(o[4]=f=>{var r;return(r=e(n))==null?void 0:r.abort()}),onFocus:ue,onContinue:o[5]||(o[5]=f=>R("继续","btn"))},{btn:d(()=>[_("div",st,[p(h,{class:"min-w-[280px] select-class",sub_id:e(V),"onUpdate:sub_id":o[2]||(o[2]=f=>te(V)?V.value=f:null),"onUpdate:modelConfig":ie},null,8,["sub_id","onUpdate:modelConfig"])])]),_:1},8,["loading","show-continue","show-file-upload","file-plugin"])])])]),_:1},8,["content","font"])])])]),_:1})])}}});const uo=Oe(it,[["__scopeId","data-v-6c59986f"]]);export{uo as default};
