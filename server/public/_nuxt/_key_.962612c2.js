import{_ as ot}from"./index.vue.74e23ebc.js";import{_ as at,b as st,a as it}from"./index.ff59938d.js";import{_ as rt}from"./index.vue.7f39d825.js";import{a as nt,e as lt,m as ct,cB as ze,a6 as dt,a7 as ut,u as pt,ai as le,al as ce,j as K,d as ft}from"./entry.dfbfd4fd.js";import{E as vt}from"./index.2e91aacc.js";import{_ as _t}from"./index.a47f7f49.js";import{k as ht,s as T,a as m,aa as mt,r as de,l as je,b as yt,E as gt,j as wt,H as u,I as w,J as a,u as e,T as Ie,R as y,Z as B,X as f,V as v,U as k,S as Pe,aj as Ve,$ as $e,a0 as Ae,_ as ue,a7 as Q,ag as xt,ah as bt,n as kt}from"./swiper-vue.2eb6bd20.js";import{u as Rt}from"./asyncData.eaddccf2.js";import{u as Ct}from"./useCopy.5611cfa5.js";import{u as Et,a as Tt}from"./useRecorder.ad274156.js";import{u as St}from"./useAudioPlay.fe45c428.js";import{_ as Lt}from"./loading.f19aad9d.js";import{_ as zt}from"./login.vue.f6e49193.js";import{C as jt,c as It,b as Pt,r as Vt,a as $t,v as At,d as Bt}from"./robot.b9f1d754.js";import{P as Ht}from"./index.e94bc8a7.js";import{E as Be}from"./index.17567b0d.js";import{_ as Ot}from"./_plugin-vue_export-helper.c27b6911.js";import"./index.edaf9b5e.js";import"./index.e979a1ab.js";/* empty css               */import"./el-image-viewer.d5621b18.js";import"./throttle.d40f833a.js";import"./debounce.8cbe4cfc.js";import"./position.4bcf7430.js";import"./file.598d0601.js";import"./index.f647f618.js";import"./___vite-browser-external.5512611b.js";import"./index.9c8f8f3a.js";import"./index.6c069afb.js";import"./use-dialog.7d399731.js";import"./isUndefined.aa0326a0.js";import"./refs.cabac943.js";/* empty css                  */import"./el-link.5fd49d40.js";/* empty css                     */import"./knowledge.51dee290.js";import"./chat.01f4dab8.js";import"./download.f61d7233.js";import"./qrcode.vue.esm.415e365a.js";import"./isString.78966428.js";import"./el-upload.5844c619.js";import"./el-progress.8f5e9f30.js";import"./cloneDeep.4e82bacf.js";import"./_baseClone.20563df6.js";import"./_getTag.83294aff.js";import"./isEqual.0df0ab2c.js";import"./index.883ed08b.js";import"./castArray.c741e965.js";import"./el-form-item.4ed993c7.js";/* empty css                */const He=""+new URL("user_avatar.43fe6396.png",import.meta.url).href,Oe=D=>(xt("data-v-44d27aba"),D=D(),bt(),D),Mt={class:"h-full flex flex-col max-w-[720px] mx-auto bg-page rounded-[10px] overflow-hidden",style:{"box-shadow":"0px 5px 40px 0px rgba(0, 0, 0, 0.05)"}},Nt={class:"flex p-main items-center bg-white"},Dt=["src"],qt={class:"text-2xl line-clamp-1"},Ft={class:"text-tx-secondary line-clamp-1"},Ut={class:"flex-1 min-h-0"},Wt={ref:"containerRef",class:"h-full flex flex-col rounded relative"},Jt={class:"absolute top-0 left-0 w-full h-full flex flex-col z-10"},Zt={class:"flex-1 min-h-0"},Gt={class:"p-main"},Kt={class:"my-[5px]"},Qt={class:"bg-white"},Xt={key:0,class:"pb-[10px] text-center text-tx-regular"},Yt={key:1,class:"h-full relative"},eo=["width","height"],to={class:"h-full flex justify-center items-center"},oo=Oe(()=>a("img",{class:"w-[400px]",src:Lt,alt:""},null,-1)),ao=[oo],so={class:"p-[20px] h-full flex relative z-10"},io={class:"flex-1 h-full flex flex-col"},ro={class:"flex-1 min-h-0"},no={class:"flex items-center cursor-pointer"},lo={class:"text-xl flex-1 min-w-0 text-white"},co=Oe(()=>a("div",{class:"flex justify-center"},null,-1)),uo={class:"h-full flex"},po={class:"h-full flex flex-col items-center w-[160px] justify-end"},fo=["width","height","id"],vo={class:"text-xs text-white bg-[rgba(51,51,51,0.3)] py-[5px] px-[10px] rounded my-[10px]"},_o={class:"w-[400px] h-full flex flex-col mr-[20px] pt-[100px]"},ho={class:"flex-1 min-h-0 bg-[rgba(0,0,0,0.5)] rounded-[20px] overflow-hidden flex flex-col"},mo={class:"flex-1 min-h-0"},yo={class:"py-4 px-[20px]"},go={key:1,class:"h-full flex justify-center text-tx-secondary items-center"},wo={key:0,class:"flex justify-center items-center py-[10px]"},xo={class:"flex flex-col justify-center items-center"},bo={class:"flex justify-center mt-4"},ko=ht({__name:"[key]",async setup(D){let q,pe;const F=nt(),Me=lt(),C=ct(),{copy:Ne}=Ct(),X=T(),{key:x=""}=Me.params,S=m(""),{height:De,width:Ro}=ze(),{data:i}=([q,pe]=mt(()=>Rt(()=>jt({apikey:x}),{default(){return{robot:{}}}},"$89nQiJhyNZ")),q=await q,pe(),q),Y=T(),L=de({_index:-1,robot_id:i.value.robot.id,record_id:-1,content:""}),qe=(t,o)=>{var c;L.record_id=t.id,L._index=o,(c=Y.value)==null||c.open()},Fe=async()=>{var t;try{await It(L),(t=Y.value)==null||t.close(),L.content="",h.value[L._index].is_feedback=1}catch(o){console.log("反馈提交失败-->",o)}},$=je(()=>i.value.chat_type===2&&i.value.robot.is_digital&&i.value.digital.id&&!i.value.digital.is_disable?2:1);F.isMobile&&$.value===2&&window.location.replace(`/mobile/packages/pages/digital_chat/share_chat?key=${x}`);const fe=je(()=>{var t;return((t=i.value.menus)==null?void 0:t.map(o=>({keyword:o})))||[]}),H=async()=>{var o;const t=le(ce,{});if(S.value=t.value[x]||"",i.value.pwd&&!S.value)return(o=X.value)==null||o.open(),Promise.reject()},Ue=async t=>{var c;const o=le(ce,{});S.value=t.password,o.value=Object.assign(o.value,{[x]:t.password}),(c=X.value)==null||c.close(),Le()},ve=()=>{const t=le(ce,{});t.value=Object.assign(t.value,{[x]:""})},h=m([]);let ee=0;const te=async()=>{try{const t=await $t({share_apikey:x,identity:C.visitorId,page_size:25e3},{password:S.value,authorization:x,identity:C.visitorId});if(h.value=t.lists||[],setTimeout(()=>{O()}),$.value===2&&g.value==3){const o=h.value[h.value.length-1];o&&o.id!==ee&&(ee=o.id,Qe(ee))}}catch(t){return t=="访问密码错误!"&&(ve(),await H()),Promise.reject()}},_e=async()=>{await H(),await K.confirm("确定清空记录？"),await Pt({},{password:S.value,authorization:x,identity:C.visitorId}),te()};let p=null;const z=m(!1),U=T(),W=async(t,o="input")=>{var _;if(await C.getFingerprint(),await H(),!t)return K.msgError("请输入问题");if(z.value)return;z.value=!0,b(3);const c=Date.now();h.value.push({type:1,content:t}),h.value.push({type:2,typing:!0,content:"",key:c}),(_=U.value)==null||_.setInputValue();const s=h.value.find(r=>r.key===c);p=Vt({question:t,stream:!0},{password:S.value,authorization:x,identity:C.visitorId}),p.addEventListener("chat",({data:r})=>{const{data:n,index:R}=r;s.content||(s.content=""),s.content+=n}),p.addEventListener("file",({data:r})=>{try{const n=JSON.parse(r.data);s.files=n}catch(n){console.error(n)}}),p.addEventListener("image",({data:r})=>{try{const n=JSON.parse(r.data);s.images=n}catch(n){console.error(n)}}),p.addEventListener("video",({data:r})=>{try{const n=JSON.parse(r.data);s.videos=n}catch(n){console.error(n)}}),p.addEventListener("close",()=>{setTimeout(async()=>{await te(),s.typing=!1,z.value=!1,O()},600)}),p.addEventListener("error",r=>{var n,R,P;b(1),r.errorType==="connectError"&&K.msgError("请求失败，请重试"),((n=r.data)==null?void 0:n.code)===1200&&(K.msgError((R=r.data)==null?void 0:R.message),ve(),setTimeout(()=>{H()},10)),["connectError","responseError"].includes(r.errorType)&&(h.value.splice(h.value.length-2,2),o==="input"&&((P=U.value)==null||P.setInputValue(t))),s.typing=!1,setTimeout(()=>{z.value=!1},200)})},J=T(),oe=m(),O=async()=>{var o,c,s;const t=(c=(o=J.value)==null?void 0:o.wrapRef)==null?void 0:c.scrollHeight;(s=J.value)==null||s.setScrollTop(t)},{height:We}=dt(oe);ut(We,()=>{z.value&&O()},{throttle:500,immediate:!0});const g=m(0),Je=de({[0]:"正在初始化对话...",[1]:"点击开始说话",[2]:"我在听，您请说...",[3]:"稍等，让我想一想",[4]:"正在回复中..."}),b=t=>{$.value===2&&(g.value=t)},he=m(),A=m(!0),ae=m(!1),se=m(0),j=m(!1),me=m(0),E=de({id:"audio-canvas",width:80,height:40,minHeight:5,scale:2}),{render:Ze,stopRender:Ge,draw:Co}=Et(E),{start:Ke,stop:ie,isRecording:M,authorize:ye,close:Eo,isOpen:To}=Tt({onstart(){b(2),clearTimeout(he.value),j.value=!1,se.value=Date.now()},async onstop(t){if(Ge(),j.value=!1,!ae.value){b(1);return}ae.value=!1,b(3);try{const o=await At({file:t.blob});if(!o.text){A.value&&I();return}W(o.text,"voice")}catch{A.value&&I()}},async ondata(t){var c;const o=Date.now();j.value&&Ze(t),t.powerLevel>=10&&(clearTimeout(me.value),g.value=2,j.value=!0,se.value=o,me.value=setTimeout(()=>{ae.value=!0,clearTimeout(he.value),we(),ie()},2e3)),o-se.value>=((c=i.value.digital)==null?void 0:c.idle_time)*1e3&&(j.value||(Ye(),ie()))}}),{play:ge,pause:we,audioPlaying:xe}=St({onstart(){g.value=4,re.value&&(re.value=!1)},onstop(){b(2),A.value?I():b(1)},onerror(){b(1)}}),Qe=async t=>{ge(async()=>await be({type:2,record_id:t}),!1)},I=async()=>{M.value||(await ye(),Ke())},Xe=async()=>{if(g.value==4){we(),I();return}g.value!=3&&(M.value?(A.value=!1,ie(),b(1)):(A.value=!0,I()))},be=async t=>{try{const{url:o}=await Bt(t,{password:S.value,authorization:x,identity:C.visitorId});return o}catch{return b(1),Promise.reject()}},Z=m(""),re=m(!1),Ye=async()=>{if(!i.value.robot.is_digital||!i.value.digital.id||(Z.value||(Z.value=await be({type:3,record_id:i.value.robot.id})),!Z.value))return Promise.reject();re.value=!0;const t=Date.now();h.value.push({type:2,typing:!1,content:i.value.digital.idle_reply,key:t}),await kt(),O(),ge(Z.value,!1)};yt(g,t=>{switch(t){case 2:I()}}),T();const ne=T(),{width:ke,height:Re}=ze(),Ce=T(),Ee=T(),Te=async t=>new Promise((o,c)=>{const s=document.createElement("video");s.src=t,s.preload="auto",s.loop=!0,s.muted=!0,s.autoplay=!1,s.playsInline=!0,s.play(),s.addEventListener("loadedmetadata",_=>{s.width=s.videoWidth,s.height=s.videoHeight,o(s)}),s.addEventListener("error",_=>{c(_)}),s.addEventListener("play",_=>{Se()})}),Se=()=>{if(!ne.value)return;const t=ke.value*2,o=Re.value*2,c=ne.value.getContext("2d");if(!c)return;const s=g.value===4?Ee.value:Ce.value;if(!s)return;c.clearRect(0,0,t,o);const{videoHeight:_,videoWidth:r}=s;let n=0,R=0,P=r,G=_;if(r/_>=t/o){const l=t*_/o;n=(r-l)/2,P=l}else{const l=o*r/t;R=(_-l)/2,G=l}c.drawImage(s,n,R,P,G,0,0,t,o),requestAnimationFrame(Se)},Le=async()=>{if(await te(),$.value==2){Ce.value=await Te(i.value.digital.wide_stay_video),Ee.value=await Te(i.value.digital.wide_talk_video),A.value=!0;try{await ye(),I()}catch{b(1)}setTimeout(()=>{O()},100)}};gt(async()=>{await C.getFingerprint(),await H(),Le()});const et=()=>{p==null||p.removeEventListener("chat"),p==null||p.removeEventListener("close"),p==null||p.removeEventListener("error"),p==null||p.abort()};return wt(()=>{et()}),pt({title:i.value.name}),(t,o)=>{const c=ot,s=at,_=it,r=rt,n=ft,R=st,P=vt,G=_t;return u(),w("div",null,[a("div",{class:"layout-bg",style:ue({height:`${e(De)}px`})},[e($)===1?(u(),w("div",{key:0,class:Ie(["h-full",{"p-main":!e(F).isMobile}])},[a("div",Mt,[a("div",Nt,[e(i).robot.image?(u(),w("img",{key:0,src:e(i).robot.image,class:"w-[40px] h-[40px] mr-[10px] flex-none rounded-full",alt:""},null,8,Dt)):y("",!0),a("div",null,[a("div",qt,B(e(i).robot.name),1),a("div",Ft,B(e(i).robot.intro),1)])]),a("div",Ut,[f(P,{class:"h-full",content:e(F).getChatConfig.watermark,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:v(()=>{var l,V;return[a("div",Wt,[a("div",Jt,[a("div",Zt,[f(e(Be),{ref_key:"scrollbarRef",ref:J},{default:v(()=>[a("div",Gt,[a("div",{ref_key:"innerRef",ref:oe},[e(i).robot.welcome_introducer?(u(),k(s,{key:0,class:"mb-[20px]",type:"left",avatar:`${e(i).robot.icons?e(i).robot.icons:e(i).robot.image}`,bg:"#fff"},{default:v(()=>[f(c,{content:e(i).robot.welcome_introducer,onClickCustomLink:o[0]||(o[0]=d=>W(d,"link"))},null,8,["content"])]),_:1},8,["avatar"])):y("",!0),(u(!0),w(Pe,null,Ve(e(h),(d,N)=>(u(),w("div",{key:d.id+""+N,class:"mt-4"},[d.type==1?(u(),k(s,{key:0,type:"right",bg:"var(--el-color-primary)",color:"white",avatar:e(He)},{actions:v(()=>[a("div",Kt,[f(n,{link:"",type:"info",onClick:tt=>e(Ne)(d.content)},{icon:v(()=>[f(r,{name:"el-icon-CopyDocument"})]),default:v(()=>[Q(" 复制 ")]),_:2},1032,["onClick"])])]),default:v(()=>[f(_,{content:d.content},null,8,["content"])]),_:2},1032,["avatar"])):y("",!0),d.type==2?(u(),k(s,{key:1,type:"left",time:d.create_time,avatar:`${e(i).robot.icons?e(i).robot.icons:e(i).robot.image}`,bg:"#fff"},{outer_actions:v(()=>[d.create_time?(u(),k(n,{key:0,class:"ml-[52px] mt-2",style:{"--el-button-border-color":"transparent","--el-color-info-light-8":"transparent"},type:d.is_feedback?"info":"primary",plain:!0,bg:"",size:"small",disabled:d.is_feedback,onClick:tt=>qe(d,N)},{default:v(()=>[Q(B(d.is_feedback?"已反馈":"反馈"),1)]),_:2},1032,["type","disabled","onClick"])):y("",!0)]),default:v(()=>[f(_,{content:String(d.content),type:"html",typing:d.typing,"show-copy":"","show-context":!!e(i).robot.is_show_context,"show-quote":!!e(i).robot.is_show_quote,"show-voice":e(F).getIsVoiceOpen,context:d.context,quotes:d.quotes,images:d.images,files:d.files,videos:d.videos,"record-id":d.id,"record-type":2,channel:e(x),"user-id":e(C).visitorId},null,8,["content","typing","show-context","show-quote","show-voice","context","quotes","images","files","videos","record-id","channel","user-id"])]),_:2},1032,["time","avatar"])):y("",!0)]))),128))],512)])]),_:1},512)]),a("div",Qt,[f(R,{ref_key:"chatActionRef",ref:U,loading:e(z),menus:e(fe),"btn-color":"#f6f6f6",onEnter:W,onClear:_e,onPause:o[1]||(o[1]=d=>{var N;return(N=e(p))==null?void 0:N.abort()})},null,8,["loading","menus"]),(l=e(i).robot)!=null&&l.copyright?(u(),w("div",Xt,B((V=e(i).robot)==null?void 0:V.copyright),1)):y("",!0)])])],512)]}),_:1},8,["content","font"])])])],2)):y("",!0),e($)===2?(u(),w("div",Yt,[a("canvas",{ref_key:"canvasRef",ref:ne,id:"digital-canvas",width:e(ke)*2,height:e(Re)*2},null,8,eo),$e(a("div",to,ao,512),[[Ae,e(g)===0]]),$e(a("div",{class:"h-full",style:ue({background:e(i).robot.digital_bg})},[a("div",so,[a("div",io,[a("div",ro,[a("div",no,[a("div",lo,B(e(i).name),1)])]),co]),a("div",uo,[a("div",po,[a("div",{class:Ie(["recorder gradient-button",{"recorder--stop":!e(M)&&!e(xe)}]),onClick:Xe},[e(j)?(u(),w("canvas",{key:0,style:ue({width:`${e(E).width}px`,height:`${e(E).height}px`}),width:e(E).width*e(E).scale,height:e(E).height*e(E).scale,id:e(E).id},null,12,fo)):y("",!0),e(M)&&!e(j)?(u(),k(r,{key:1,name:"el-icon-Microphone",size:40})):e(xe)?(u(),k(r,{key:2,name:"local-icon-pause",size:40})):e(M)?y("",!0):(u(),k(r,{key:3,name:"el-icon-Mute",size:40}))],2),a("div",vo,[a("div",null,B(e(Je)[e(g)]),1)])]),a("div",_o,[a("div",ho,[a("div",mo,[e(h).length?(u(),k(e(Be),{key:0,ref_key:"scrollbarRef",ref:J},{default:v(()=>[a("div",yo,[a("div",{ref_key:"innerRef",ref:oe},[(u(!0),w(Pe,null,Ve(e(h),(l,V)=>(u(),w("div",{key:l.id+""+V,class:"mt-4 sm:pb-[20px]"},[l.type==1?(u(),k(s,{key:0,type:"right",avatar:e(He),color:"white"},{default:v(()=>[f(_,{content:String(l.content)},null,8,["content"])]),_:2},1032,["avatar"])):y("",!0),l.type==2?(u(),k(s,{key:1,type:"left",time:l.create_time,avatar:e(i).robot.icons?e(i).robot.icons:e(i).robot.image,bg:"#fff"},{default:v(()=>[f(_,{content:String(l.content),type:"html",typing:l.typing,images:l.images,files:l.files,videos:l.videos,"record-id":l.id,"record-type":2},null,8,["content","typing","images","files","videos","record-id"])]),_:2},1032,["time","avatar"])):y("",!0)]))),128))],512)])]),_:1},512)):(u(),w("div",go," 暂无聊天记录 "))]),e(z)?(u(),w("div",wo,[f(n,{color:"#fff",round:"",onClick:o[2]||(o[2]=l=>{var V;return(V=e(p))==null?void 0:V.abort()})},{default:v(()=>[Q(" 停止 ")]),_:1})])):y("",!0)]),a("div",null,[f(R,{ref_key:"chatActionRef",ref:U,loading:[3,4].includes(e(g)),menus:e(fe),"show-pause":!1,"show-clear":!1,onEnter:W},null,8,["loading","menus"])])]),a("div",xo,[a("div",{class:"gradient-button",onClick:_e},[f(r,{name:"local-icon-clear",size:24})])])])])],4),[[Ae,e(g)!==0]])])):y("",!0)],4),f(zt,{ref_key:"loginRef",ref:X,onConfirm:Ue},null,512),f(Ht,{ref_key:"popupRef",ref:Y,async:!0,width:"390",title:"问题反馈",appendToBody:!1,class:"feedback-pop"},{footer:v(()=>[a("div",bo,[f(n,{type:"primary",onClick:Fe},{default:v(()=>[Q(" 提交反馈 ")]),_:1})])]),default:v(()=>[f(G,{modelValue:e(L).content,"onUpdate:modelValue":o[3]||(o[3]=l=>e(L).content=l),rows:"8",placeholder:"描述一下你遇到了什么问题"},null,8,["modelValue"])]),_:1},512)])}}});const Ra=Ot(ko,[["__scopeId","data-v-44d27aba"]]);export{Ra as default};
