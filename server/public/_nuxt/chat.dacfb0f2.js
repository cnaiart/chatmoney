import{_ as Pe}from"./index.vue.7f39d825.js";import{b as $e,a as Me,_ as Ne}from"./index.ff59938d.js";import{h as Fe,m as Oe,e as Ue,a as We,a6 as Je,a7 as Ge,cB as Xe,j as A,d as Ze}from"./entry.dfbfd4fd.js";import{E as Ke}from"./el-empty.6e01cec2.js";import{k as Qe,s as S,l as M,a as v,aa as Ye,r as he,j as et,E as tt,n as _e,H as p,I as b,$ as ye,a0 as ge,u as e,J as s,_ as xe,X as k,Z as we,T as at,R as B,U as L,V as H,S as be,aj as ot,a7 as ke,ag as st,ah as it}from"./swiper-vue.2eb6bd20.js";import{u as rt}from"./asyncData.eaddccf2.js";import{u as nt,a as lt}from"./useRecorder.ad274156.js";import{u as ct}from"./useAudioPlay.fe45c428.js";import{_ as ut}from"./loading.f19aad9d.js";import{g as dt,b as pt,r as vt,a as ft,v as mt,d as ht}from"./robot.b9f1d754.js";import{c as _t}from"./create_record_null.e42f56ab.js";import{E as yt}from"./index.17567b0d.js";import{_ as gt}from"./_plugin-vue_export-helper.c27b6911.js";import"./index.e979a1ab.js";/* empty css               */import"./index.vue.74e23ebc.js";import"./index.edaf9b5e.js";import"./el-image-viewer.d5621b18.js";import"./throttle.d40f833a.js";import"./debounce.8cbe4cfc.js";import"./position.4bcf7430.js";import"./file.598d0601.js";import"./index.f647f618.js";import"./___vite-browser-external.5512611b.js";import"./index.9c8f8f3a.js";import"./index.6c069afb.js";import"./use-dialog.7d399731.js";import"./isUndefined.aa0326a0.js";import"./refs.cabac943.js";/* empty css                  */import"./el-link.5fd49d40.js";import"./useCopy.5611cfa5.js";/* empty css                     */import"./knowledge.51dee290.js";import"./chat.01f4dab8.js";import"./download.f61d7233.js";import"./qrcode.vue.esm.415e365a.js";import"./isString.78966428.js";import"./el-upload.5844c619.js";import"./el-progress.8f5e9f30.js";import"./cloneDeep.4e82bacf.js";import"./_baseClone.20563df6.js";import"./_getTag.83294aff.js";import"./isEqual.0df0ab2c.js";const Re=D=>(st("data-v-3e566265"),D=D(),it(),D),xt={class:"h-screen w-screen flex justify-center items-center"},wt=Re(()=>s("img",{class:"w-[400px]",src:ut,alt:""},null,-1)),bt=[wt],kt=["width","height"],Rt={class:"p-[20px] flex h-full relative z-10"},Et={class:"flex-1 h-full flex flex-col"},St={class:"flex-1 min-h-0"},Tt={class:"flex items-center cursor-pointer"},Ct={class:"text-xl flex-1 min-w-0 ml-[10px] text-white"},Lt=Re(()=>s("div",{class:"flex justify-center"},null,-1)),It={class:"h-full flex"},jt={class:"h-full flex flex-col items-center w-[160px] justify-end"},zt=["width","height","id"],Vt={class:"text-xs text-white bg-[rgba(51,51,51,0.3)] py-[5px] px-[10px] rounded my-[10px]"},qt={class:"w-[400px] h-full flex flex-col mr-[20px] pt-[100px]"},At={class:"flex-1 min-h-0 bg-[rgba(0,0,0,0.5)] rounded-[20px] overflow-hidden flex flex-col"},Bt={class:"flex-1 min-h-0"},Ht={class:"py-4 px-[20px]"},Dt={key:1,class:"h-full flex justify-center text-tx-secondary items-center"},Pt={key:0,class:"flex justify-center items-center py-[10px]"},$t={class:"flex flex-col justify-center items-center"},Mt={key:1,class:"h-screen w-screen flex flex-col items-center justify-center"},Nt=Qe({__name:"chat",async setup(D){let ae,oe;S();const N=Fe(),R=Oe(),F=Ue(),I=M(()=>F.query.id),P=M(()=>F.query.squareId),O=M(()=>F.query.cateId),U=We(),i=v({}),Ee=async()=>{i.value=await dt({id:I.value})},m=v([]);let W=0;const J=async()=>{const t=await ft({square_id:P.value,category_id:O.value,robot_id:I.value,page_size:25e3});if(m.value=t.lists||[],f.value==3){const a=m.value[m.value.length-1];a&&a.id!==W&&(W=a.id,qe(W))}};[ae,oe]=Ye(()=>rt(()=>J(),{lazy:!0},"$Mtlbt2SHcf")),await ae,oe();const se=()=>{P.value?N.replace({path:"/robot_square"}):N.replace({path:"/application/layout/robot"})},f=v(0),Se=he({[0]:"正在初始化对话...",[1]:"点击开始说话",[2]:"我在听，您请说...",[3]:"稍等，让我想一想",[4]:"正在回复中..."}),G=S();M(()=>f.value==4?i.value.digital.wide_talk_video:i.value.digital.wide_stay_video);const Te=async()=>{if(!R.isLogin)return R.toggleShowLogin();y.value||(await A.confirm("确定清空记录？"),await pt({square_id:P.value,category_id:O.value,robot_id:I.value}),J())},j=S(),Ce=()=>{var t;if(!R.isLogin)return(t=j.value)==null||t.blur(),R.toggleShowLogin();z()};let n=null;const y=v(!1),ie=async(t,a="input")=>{var u;if(!R.isLogin)return R.toggleShowLogin();if(!t)return A.msgError("请输入问题");if(y.value||!I.value)return;V(),h(3);const r=Date.now();y.value=!0,m.value.push({type:1,content:t}),m.value.push({type:2,typing:!0,content:"",key:r}),(u=j.value)==null||u.setInputValue();const o=m.value.find(l=>l.key===r);n=vt({square_id:P.value,cate_id:O.value,robot_id:I.value,question:t,stream:!0}),n.addEventListener("chat",({data:l})=>{const{data:c,index:x}=l;o.content||(o.content=""),o.content+=c}),n.addEventListener("file",({data:l})=>{try{const c=JSON.parse(l.data);o.files=c}catch(c){console.error(c)}}),n.addEventListener("image",({data:l})=>{try{const c=JSON.parse(l.data);o.images=c}catch(c){console.error(c)}}),n.addEventListener("close",async()=>{setTimeout(async()=>{await J(),o.typing=!1,y.value=!1,z()},500)}),n.addEventListener("error",async l=>{var c,x,w;if(h(1),((c=l.data)==null?void 0:c.code)===1100){try{U.getIsShowRecharge?(await A.confirm(`${U.getTokenUnit}数量已用完，请前往充值`),N.push("/user/recharge")):A.msgError(`${U.getTokenUnit}数量已用完。请联系客服增加`)}finally{a==="input"&&((x=j.value)==null||x.setInputValue(t))}return}l.errorType==="connectError"&&A.msgError("请求失败，请重试"),["connectError","responseError"].includes(l.errorType)&&(m.value.splice(m.value.length-2,2),a==="input"&&((w=j.value)==null||w.setInputValue(t))),o.typing=!1,setTimeout(()=>{y.value=!1},200)})},X=S(),re=v(),z=async()=>{var a,r,o;const t=(r=(a=X.value)==null?void 0:a.wrapRef)==null?void 0:r.scrollHeight;(o=X.value)==null||o.setScrollTop(t)},{height:Le}=Je(re);Ge(Le,()=>{y.value&&z()},{throttle:500,immediate:!0});const ne=v(),T=v(!0),h=t=>{f.value=t},Z=v(!1),K=v(0),E=v(!1),le=v(0),g=he({id:"audio-canvas",width:80,height:40,minHeight:5,scale:2}),{render:Ie,stopRender:je,draw:Ft}=nt(g),{start:ze,stop:V,isRecording:q,authorize:Ve,close:Ot,isOpen:Ut}=lt({onstart(){h(2),clearTimeout(ne.value),E.value=!1,K.value=Date.now()},async onstop(t){if(je(),E.value=!1,!Z.value){h(1);return}Z.value=!1,h(3);try{const a=await mt({file:t.blob});if(!a.text){T.value&&C();return}ie(a.text,"voice")}catch{T.value&&C()}},ondata(t){var r;const a=Date.now();E.value&&Ie(t),t.powerLevel>=10&&(clearTimeout(le.value),f.value=2,E.value=!0,K.value=a,le.value=setTimeout(()=>{Z.value=!0,clearTimeout(ne.value),Q(),V()},2e3)),a-K.value>=((r=i.value.digital)==null?void 0:r.idle_time)*1e3&&(E.value||(Be(),V()))}}),{play:ce,pause:Q,audioPlaying:ue}=ct({onstart(){f.value=4,Y.value&&(Y.value=!1)},onstop(){h(2),T.value?C():h(1)},onerror(){h(1)}}),qe=async t=>{ce(async()=>await de({type:2,record_id:t}),!1)},C=async()=>{q.value||ze()},Ae=async()=>{if(f.value==4){Q(),C();return}f.value!=3&&(q.value?(T.value=!1,V(),h(1)):(T.value=!0,C()))},de=async t=>{try{const{url:a}=await ht(t);return a}catch{return h(1),Promise.reject()}},$=v(""),Y=v(!1),Be=async()=>{if(!i.value.is_digital||!i.value.digital_id||i.value.digital.is_disable||($.value||($.value=await de({type:3,record_id:i.value.id})),!$.value))return Promise.reject();Y.value=!0;const t=Date.now();m.value.push({type:2,typing:!1,content:i.value.digital.idle_reply,key:t}),await _e(),z(),ce($.value,!1)},He=()=>{n==null||n.removeEventListener("close"),n==null||n.removeEventListener("chat"),n==null||n.removeEventListener("error"),n==null||n.abort(),y.value=!1};et(()=>{He(),Q(),V()});const De=S(),{width:pe,height:ve}=Xe(),ee=S(),te=S(),fe=async t=>new Promise((a,r)=>{const o=document.createElement("video");o.src=t,o.preload="auto",o.loop=!0,o.muted=!0,o.addEventListener("loadedmetadata",u=>{o.width=o.videoWidth,o.height=o.videoHeight,a(o)}),o.addEventListener("error",u=>{r(u)}),o.addEventListener("play",u=>{me()})}),me=()=>{if(!G.value)return;const t=pe.value*2,a=ve.value*2,r=G.value.getContext("2d");if(!r)return;const o=f.value===4?te.value:ee.value;if(!o)return;r.clearRect(0,0,t,a);const{videoHeight:u,videoWidth:l}=o;let c=0,x=0,w=l,d=u;if(l/u>=t/a){const _=t*u/a;c=(l-_)/2,w=_}else{const _=a*l/t;x=(u-_)/2,d=_}r.drawImage(o,c,x,w,d,0,0,t,a),requestAnimationFrame(me)};return tt(async()=>{if(await Ee(),!(!i.value.digital_id||i.value.digital.is_disable)){T.value=!0,ee.value=await fe(i.value.digital.wide_stay_video),te.value=await fe(i.value.digital.wide_talk_video),ee.value.play(),te.value.play();try{await Ve(),C()}catch{h(1)}await _e(),z()}}),(t,a)=>{var w;const r=Pe,o=Me,u=Ne,l=Ze,c=$e,x=Ke;return p(),b(be,null,[ye(s("div",xt,bt,512),[[ge,e(f)===0]]),ye(s("div",null,[e(i).digital_id&&!((w=e(i).digital)!=null&&w.is_disable)?(p(),b("div",{key:0,ref_key:"containRef",ref:De,class:"h-screen w-screen relative overflow-hidden",style:xe({background:e(i).digital_bg})},[s("canvas",{ref_key:"canvasRef",ref:G,id:"digital-canvas",width:e(pe)*2,height:e(ve)*2},null,8,kt),s("div",Rt,[s("div",Et,[s("div",St,[s("div",Tt,[s("div",{class:"flex bg-white p-[5px] text-bold rounded-[50%] text-primary shadow-light",onClick:se},[k(r,{name:"el-icon-Back",size:18})]),s("div",Ct,we(e(i).name),1)])]),Lt]),s("div",It,[s("div",jt,[s("div",{class:at(["recorder gradient-button",{"recorder--stop":!e(q)&&!e(ue)}]),onClick:Ae},[e(E)?(p(),b("canvas",{key:0,style:xe({width:`${e(g).width}px`,height:`${e(g).height}px`}),width:e(g).width*e(g).scale,height:e(g).height*e(g).scale,id:e(g).id},null,12,zt)):B("",!0),e(q)&&!e(E)?(p(),L(r,{key:1,name:"el-icon-Microphone",size:40})):e(ue)?(p(),L(r,{key:2,name:"local-icon-pause",size:40})):e(q)?B("",!0):(p(),L(r,{key:3,name:"el-icon-Mute",size:40}))],2),s("div",Vt,[s("div",null,we(e(Se)[e(f)]),1)])]),s("div",qt,[s("div",At,[s("div",Bt,[e(m).length?(p(),L(e(yt),{key:0,ref_key:"scrollbarRef",ref:X},{default:H(()=>[s("div",Ht,[s("div",{ref_key:"innerRef",ref:re},[(p(!0),b(be,null,ot(e(m),(d,_)=>(p(),b("div",{key:d.id+""+_,class:"mt-4 sm:pb-[20px]"},[d.type==1?(p(),L(u,{key:0,type:"right",avatar:e(R).userInfo.avatar,color:"white"},{default:H(()=>[k(o,{content:String(d.content)},null,8,["content"])]),_:2},1032,["avatar"])):B("",!0),d.type==2?(p(),L(u,{key:1,type:"left",time:d.create_time,avatar:e(i).icons?e(i).icons:e(i).image,bg:"#fff"},{default:H(()=>[k(o,{content:String(d.content),type:"html",typing:d.typing,images:d.images,files:d.files,"record-id":d.id,"record-type":2},null,8,["content","typing","images","files","record-id"])]),_:2},1032,["time","avatar"])):B("",!0)]))),128))],512)])]),_:1},512)):(p(),b("div",Dt," 暂无聊天记录 "))]),e(y)?(p(),b("div",Pt,[k(l,{color:"#fff",round:"",onClick:a[0]||(a[0]=d=>{var _;return(_=e(n))==null?void 0:_.abort()})},{default:H(()=>[ke(" 停止 ")]),_:1})])):B("",!0)]),s("div",null,[k(c,{ref_key:"chatActionRef",ref:j,loading:[3,4].includes(e(f)),menus:e(i).menus,"show-pause":!1,"show-clear":!1,onEnter:ie,onFocus:Ce},null,8,["loading","menus"])])]),s("div",$t,[s("div",{class:"gradient-button",onClick:Te},[k(r,{name:"local-icon-clear",size:24})])])])])],4)):(p(),b("div",Mt,[k(x,{description:"该智能体暂未配置形象或形象已被禁用",image:e(_t)},null,8,["image"]),k(l,{type:"primary",round:"",onClick:se},{default:H(()=>[ke(" 返回智能体 ")]),_:1})]))],512),[[ge,e(f)!==0]])],64)}}});const Ba=gt(Nt,[["__scopeId","data-v-3e566265"]]);export{Ba as default};
